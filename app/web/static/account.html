<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>My Account - EasyRFP</title>
<link href="/static/css/dashboard.css" rel="stylesheet"/>
<link href="/static/css/account.css" rel="stylesheet"/>
</head>
<body>
<div class="scroll-progress" id="scrollProgress"></div>
<div class="app-shell">
<aside class="sidebar">
<div class="brand">
<svg fill="none" height="36" viewbox="0 0 40 40" width="36">
<rect fill="url(#grad1)" height="40" rx="12" width="40"></rect>
<path d="M10 20L17 27L30 13" stroke="white" stroke-linecap="round" stroke-linejoin="round" stroke-width="3.5"></path>
<defs>
<lineargradient id="grad1" x1="0" x2="40" y1="0" y2="40">
<stop offset="0%" stop-color="#126a45"></stop>
<stop offset="100%" stop-color="#22c55e"></stop>
</lineargradient>
</defs>
</svg>
<span>EasyRFP</span>
</div>
<div class="nav-label">Main Menu</div>
<nav class="navlinks">
<a class="nav-link" href="/">
<svg aria-hidden="true" fill="none" height="20" stroke="currentColor" stroke-width="2" viewbox="0 0 24 24" width="20">
<path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
<polyline points="9 22 9 12 15 12 15 22"></polyline>
</svg>
<span class="nav-text">Home</span>
</a>
<a class="nav-link" href="/opportunities">
<svg aria-hidden="true" fill="none" height="20" stroke="currentColor" stroke-width="2" viewbox="0 0 24 24" width="20">
<circle cx="11" cy="11" r="8"></circle>
<path d="m21 21-4.35-4.35"></path>
</svg>
<span class="nav-text">Discover Bids</span>
</a>
<a class="nav-link" href="/tracker/dashboard">
<svg aria-hidden="true" fill="none" height="20" stroke="currentColor" stroke-width="2" viewbox="0 0 24 24" width="20">
<rect height="7" width="7" x="3" y="3"></rect>
<rect height="7" width="7" x="14" y="3"></rect>
<rect height="7" width="7" x="14" y="14"></rect>
<rect height="7" width="7" x="3" y="14"></rect>
</svg>
<span class="nav-text">My Dashboard</span>
</a>
<a class="nav-link" href="/documents">
<svg aria-hidden="true" fill="none" height="20" stroke="currentColor" stroke-width="2" viewbox="0 0 24 24" width="20">
<path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
<polyline points="14 2 14 8 20 8"></polyline>
</svg>
<span class="nav-text">Documents</span>
</a>
<a class="nav-link" href="/ai-tools">
<svg aria-hidden="true" fill="none" height="20" stroke="currentColor" stroke-width="2" viewbox="0 0 24 24" width="20">
<path d="M12 3l1.84 3.73L18 8.27l-3 2.92.71 4.14L12 13.77l-3.71 1.95L9 11.19l-3-2.92 4.16-.54L12 3z"></path>
</svg>
<span class="nav-text">AI Studio</span>
</a>
<a class="nav-link" href="/calendar">
<svg aria-hidden="true" fill="none" height="20" stroke="currentColor" stroke-width="2" viewbox="0 0 24 24" width="20">
<rect height="18" rx="2" ry="2" width="18" x="3" y="4"></rect>
<line x1="16" x2="16" y1="2" y2="6"></line>
<line x1="8" x2="8" y1="2" y2="6"></line>
<line x1="3" x2="21" y1="10" y2="10"></line>
</svg>
<span class="nav-text">Calendar</span>
</a>
<a class="nav-link active" href="/account">
<svg aria-hidden="true" fill="none" height="20" stroke="currentColor" stroke-width="2" viewbox="0 0 24 24" width="20">
<path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
<polyline points="14 2 14 8 20 8"></polyline>
</svg>
<span class="nav-text">My Account</span>
</a>
</nav>
<div class="nav-label" style="margin-top: 24px;">Account</div>
<nav class="navlinks">
<a class="nav-link" href="/support">
<svg aria-hidden="true" fill="none" height="20" stroke="currentColor" stroke-width="2" viewbox="0 0 24 24" width="20">
<circle cx="12" cy="12" r="10"></circle>
<path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path>
<line x1="12" x2="12.01" y1="17" y2="17"></line>
</svg>
<span class="nav-text">Support</span>
</a>
</nav>
</aside>
<div class="content">
<div class="topbar" role="banner">
<div class="topbar-left">
<div class="breadcrumb">
<span class="breadcrumb-item">Home</span>
<span class="breadcrumb-sep">/</span>
<span class="breadcrumb-current">Account</span>
</div>
</div>
<div class="topbar-right">
<button class="topbar-btn" id="notifBtn" aria-label="Notifications">
<svg width="20" height="20" viewbox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
<path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path>
<path d="M13.73 21a2 2 0 0 1-3.46 0"></path>
</svg>
<span class="notification-dot notif-dot"></span>
</button>
<div class="user-avatar" title="Account">
<span id="topAvatar">--</span>
</div>
</div>
</div>
<main class="page account-page">
<div class="account-header fade-in">
<div class="account-header-left">
<div class="large-avatar" id="avatarInitials">
<span>--</span>
<button class="avatar-edit-btn">
<svg fill="none" height="14" stroke="currentColor" stroke-width="2" viewbox="0 0 24 24" width="14">
<path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
<path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
</svg>
</button>
</div>
<div class="account-header-info">
<h1 class="account-name" id="accountName"></h1>
<p class="account-email" id="accountEmail"></p>
<div class="account-badges">
<span class="badge badge-pro" id="planBadge" style="display:none;">
<svg fill="currentColor" height="12" viewbox="0 0 24 24" width="12">
<polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon>
</svg>
<span id="planBadgeLabel"></span>
</span>
<span class="badge badge-team" id="teamBadge" style="display:none;">
<svg fill="none" height="12" stroke="currentColor" stroke-width="2" viewbox="0 0 24 24" width="12">
<path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
<circle cx="9" cy="7" r="4"></circle>
<path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
<path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
</svg>
<span id="teamBadgeLabel">Team Member</span>
</span>
<span class="badge badge-verified" id="verifiedBadge" style="display:none;">
<svg fill="none" height="12" stroke="currentColor" stroke-width="2" viewbox="0 0 24 24" width="12">
<path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
<polyline points="22 4 12 14.01 9 11.01"></polyline>
</svg>
                  Verified
                </span>
<span class="badge badge-member" id="memberSince"></span>
</div>
</div>
</div>
<div class="account-header-actions">
<button class="btn-secondary" id="settingsBtn">
<svg fill="none" height="16" stroke="currentColor" stroke-width="2" viewbox="0 0 24 24" width="16">
<circle cx="12" cy="12" r="3"></circle>
<path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
</svg>
              Settings
            </button>
<button class="btn-danger-outline" id="signOutBtn">
<svg fill="none" height="16" stroke="currentColor" stroke-width="2" viewbox="0 0 24 24" width="16">
<path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
<polyline points="16 17 21 12 16 7"></polyline>
<line x1="21" x2="9" y1="12" y2="12"></line>
</svg>
              Sign Out
            </button>
</div>
</div>
<div class="account-tabs fade-in stagger-1">
<button class="account-tab active" data-tab="overview">
<svg fill="none" height="18" stroke="currentColor" stroke-width="2" viewbox="0 0 24 24" width="18">
<rect height="7" width="7" x="3" y="3"></rect>
<rect height="7" width="7" x="14" y="3"></rect>
<rect height="7" width="7" x="14" y="14"></rect>
<rect height="7" width="7" x="3" y="14"></rect>
</svg>
            Overview
          </button>
<button class="account-tab" data-tab="profile">
<svg fill="none" height="18" stroke="currentColor" stroke-width="2" viewbox="0 0 24 24" width="18">
<path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
<circle cx="12" cy="7" r="4"></circle>
</svg>
            Profile
          </button>
<button class="account-tab" data-tab="billing">
<svg fill="none" height="18" stroke="currentColor" stroke-width="2" viewbox="0 0 24 24" width="18">
<rect height="16" rx="2" ry="2" width="22" x="1" y="4"></rect>
<line x1="1" x2="23" y1="10" y2="10"></line>
</svg>
            Billing
          </button>
<button class="account-tab" data-tab="team">
<svg fill="none" height="18" stroke="currentColor" stroke-width="2" viewbox="0 0 24 24" width="18">
<path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
<circle cx="9" cy="7" r="4"></circle>
<path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
<path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
</svg>
            Team
          </button>
<button class="account-tab" data-tab="notifications">
<svg fill="none" height="18" stroke="currentColor" stroke-width="2" viewbox="0 0 24 24" width="18">
<path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path>
<path d="M13.73 21a2 2 0 0 1-3.46 0"></path>
</svg>
            Notifications
          </button>
<button class="account-tab" data-tab="security">
<svg fill="none" height="18" stroke="currentColor" stroke-width="2" viewbox="0 0 24 24" width="18">
<path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path>
</svg>
            Security
          </button>
</div>
<div class="account-content">
<div class="tab-content active" id="tab-overview">
<div class="account-grid">
<div class="account-card plan-card fade-in stagger-2">
<div class="plan-header">
<div class="plan-icon">
<svg fill="currentColor" height="24" viewbox="0 0 24 24" width="24">
<polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon>
</svg>
</div>
<div class="plan-info">
<span class="plan-label">Current Plan</span>
<h3 class="plan-name" id="planName">--</h3>
</div>
<div class="plan-price-stack">
<div class="plan-price">
<span class="price-amount" id="planPrice">--</span>
<span class="price-period" id="planPeriod"></span>
</div>
<div class="plan-renewal">
<svg fill="none" height="14" stroke="currentColor" stroke-width="2" viewbox="0 0 24 24" width="14">
<circle cx="12" cy="12" r="10"></circle>
<polyline points="12 6 12 12 16 14"></polyline>
</svg>
<span class="plan-renewal-label">Next billing:</span> <span id="planNextBilling">-</span>
</div>
</div>
</div>
<div class="plan-features">
<div class="plan-feature">
<svg fill="none" height="16" stroke="currentColor" stroke-width="2" viewbox="0 0 24 24" width="16">
<polyline points="20 6 9 17 4 12"></polyline>
</svg>
<span>Real-time opportunity updates</span>
</div>
<div class="plan-feature">
<svg fill="none" height="16" stroke="currentColor" stroke-width="2" viewbox="0 0 24 24" width="16">
<polyline points="20 6 9 17 4 12"></polyline>
</svg>
<span>Track unlimited bids</span>
</div>
<div class="plan-feature">
<svg fill="none" height="16" stroke="currentColor" stroke-width="2" viewbox="0 0 24 24" width="16">
<polyline points="20 6 9 17 4 12"></polyline>
</svg>
<span>Daily digests</span>
</div>
<div class="plan-feature">
<svg fill="none" height="16" stroke="currentColor" stroke-width="2" viewbox="0 0 24 24" width="16">
<polyline points="20 6 9 17 4 12"></polyline>
</svg>
<span>Email alerts for keywords</span>
</div>
<div class="plan-feature">
<svg fill="none" height="16" stroke="currentColor" stroke-width="2" viewbox="0 0 24 24" width="16">
<polyline points="20 6 9 17 4 12"></polyline>
</svg>
<span>File uploads (5GB)</span>
</div>
<div class="plan-feature">
<svg fill="none" height="16" stroke="currentColor" stroke-width="2" viewbox="0 0 24 24" width="16">
<polyline points="20 6 9 17 4 12"></polyline>
</svg>
<span>Calendar integration</span>
</div>
<div class="plan-feature">
<svg fill="none" height="16" stroke="currentColor" stroke-width="2" viewbox="0 0 24 24" width="16">
<polyline points="20 6 9 17 4 12"></polyline>
</svg>
<span>Priority support</span>
</div>
</div>
<div class="plan-actions">
<a class="btn-primary" data-action="compare-plans" href="/billing">Compare Plans</a>
</div>
</div>
<div class="account-card usage-card fade-in stagger-3">
<div class="card-header">
<h3 class="card-title">Usage This Month</h3>
<span class="card-period">--</span>
</div>
<div class="usage-stats">
<div class="usage-item">
<div class="usage-info">
<span class="usage-label">Active Bids</span>
<span class="usage-value" id="usageBids">--</span>
</div>
<div class="usage-bar">
<div class="usage-fill" id="usageBidsFill" style="width: 0%; background: var(--primary-gradient);"></div>
</div>
</div>
<div class="usage-item">
<div class="usage-info">
<span class="usage-label">Team Members</span>
<span class="usage-value" id="usageTeam">--</span>
</div>
<div class="usage-bar">
<div class="usage-fill" id="usageTeamFill" style="width: 0%;"></div>
</div>
</div>
<div class="usage-item">
<div class="usage-info">
<span class="usage-label">Documents Stored</span>
<span class="usage-value" id="usageDocs">--</span>
</div>
<div class="usage-bar">
<div class="usage-fill" id="usageDocsFill" style="width: 0%;"></div>
</div>
</div>
<div class="usage-item">
<div class="usage-info">
<span class="usage-label">API Calls</span>
<span class="usage-value" id="usageTokens">--</span>
</div>
<div class="usage-bar">
<div class="usage-fill" id="usageTokensFill" style="width: 0%;"></div>
</div>
</div>
</div>
</div>
<div class="account-card quick-actions-card fade-in stagger-2">
<div class="card-header">
<h3 class="card-title">Quick Actions</h3>
</div>
<div class="quick-actions-grid">
<button class="quick-action" id="qaEditProfile">
<div class="quick-action-icon">
<svg fill="none" height="20" stroke="currentColor" stroke-width="2" viewbox="0 0 24 24" width="20">
<path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
<circle cx="12" cy="7" r="4"></circle>
</svg>
</div>
<span>Edit Profile</span>
</button>
<button class="quick-action" id="qaInviteMember">
<div class="quick-action-icon blue">
<svg fill="none" height="20" stroke="currentColor" stroke-width="2" viewbox="0 0 24 24" width="20">
<path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
<circle cx="8.5" cy="7" r="4"></circle>
<line x1="20" x2="20" y1="8" y2="14"></line>
<line x1="23" x2="17" y1="11" y2="11"></line>
</svg>
</div>
<span>Invite Member</span>
</button>
<button class="quick-action" id="qaUpdatePayment">
<div class="quick-action-icon purple">
<svg fill="none" height="20" stroke="currentColor" stroke-width="2" viewbox="0 0 24 24" width="20">
<rect height="16" rx="2" ry="2" width="22" x="1" y="4"></rect>
<line x1="1" x2="23" y1="10" y2="10"></line>
</svg>
</div>
<span>Update Payment</span>
</button>
<button class="quick-action" id="qaExportData">
<div class="quick-action-icon orange">
<svg fill="none" height="20" stroke="currentColor" stroke-width="2" viewbox="0 0 24 24" width="20">
<path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
<polyline points="7 10 12 15 17 10"></polyline>
<line x1="12" x2="12" y1="15" y2="3"></line>
</svg>
</div>
<span>Export Data</span>
</button>
</div>
</div>
<div class="account-card activity-card fade-in stagger-3">
<div class="card-header">
<h3 class="card-title">Recent Activity</h3>
<a class="card-link" href="#">View All</a>
</div>
<div class="activity-list" id="activityList"></div>
</div>
<div class="account-card team-preview-card fade-in stagger-4">
<div class="card-header">
<h3 class="card-title">Your Team</h3>
<a class="card-link" href="/account/team">Manage</a>
</div>
<div class="team-list" id="teamListCard">
<div class="muted">Loading team...</div>
</div>
<button class="btn-secondary full-width" id="teamInviteCardBtn">
<svg fill="none" height="16" stroke="currentColor" stroke-width="2" viewbox="0 0 24 24" width="16">
<line x1="12" x2="12" y1="5" y2="19"></line>
<line x1="5" x2="19" y1="12" y2="12"></line>
</svg>
                  Invite New Member
                </button>
</div>
</div>
</div>
<div class="tab-content" id="tab-profile">
<div class="settings-section fade-in">
<div class="settings-header">
<h3>Personal Information</h3>
<p>Update your personal details and contact information.</p>
</div>
<div class="settings-form">
<div class="form-row">
<div class="form-group">
<label>First Name</label>
<input class="form-input" id="profileFirstName" type="text" value=""/>
</div>
<div class="form-group">
<label>Last Name</label>
<input class="form-input" id="profileLastName" type="text" value=""/>
</div>
</div>
<div class="form-group">
<label>Email Address</label>
<input class="form-input" id="profileEmail" type="email" value=""/>
<span class="form-hint">This is your primary login email</span>
</div>
<div class="form-group">
<label>Phone Number</label>
<input class="form-input" id="profilePhone" placeholder="Optional" type="tel" value=""/>
</div>
<div class="form-group">
<label>Job Title</label>
<input class="form-input" id="profileJobTitle" placeholder="Optional" type="text" value=""/>
</div>
<div class="form-actions">
<button class="btn-primary" id="savePersonalInfo" type="button">Save Changes</button>
<button class="btn-ghost" id="resetPersonalInfo" type="button">Cancel</button>
<span aria-live="polite" class="form-hint" id="personalInfoStatus"></span>
</div>
</div>
</div>
<div class="company-profile-section fade-in stagger-1" id="companyProfileCard">
<div class="section-intro">
<h2>Company Profile</h2>
<p>Complete your company profile for AI auto-fill on RFQ forms, vendor portals, and bid templates.</p>
</div>
<div class="profile-progress">
<div class="progress-header">
<span class="progress-label">Profile Completeness</span>
<span class="progress-value" id="profileCompleteness">0%</span>
</div>
<div class="progress-bar">
<div class="progress-fill" id="profileProgressFill" style="width: 0%"></div>
</div>
<p class="progress-hint" id="profileProgressHint">Complete your profile to enable AI auto-fill on RFP forms</p>
</div>
<div class="quick-setup-card" id="quickSetupCard">
<div class="quick-setup-copy">
<h4>Quick Setup</h4>
<p>Fill the essentials in a few steps to unlock AI auto-fill faster.</p>
</div>
<div class="quick-setup-actions">
<button class="btn-primary" type="button" id="startQuickSetup">Start Quick Setup</button>
<button class="btn-ghost" type="button" id="skipQuickSetup">Skip for now</button>
</div>
</div>
<div class="profile-actions">
<button class="btn-primary btn-large" id="saveCompanyProfile" type="button">Save Company Profile</button>
<button class="btn-ghost" id="resetCompanyProfile" type="button">Reset</button>
<span class="save-hint" id="companyProfileStatus" aria-live="polite"></span>
</div>
<div class="profile-panels" id="companyProfileForm">
<section class="profile-panel">
<div class="panel-header">
<div class="panel-title">
<span class="panel-icon">1</span>
<h3>Business Profile</h3>
</div>
<span class="panel-toggle">+</span>
</div>
<div class="panel-content">
<div class="sub-accordion">
<div class="sub-accordion-item open">
<button aria-expanded="true" class="sub-accordion-header" type="button">
<span>Company Information</span>
<svg fill="none" height="16" stroke="currentColor" stroke-width="2" viewbox="0 0 24 24" width="16"><polyline points="6 9 12 15 18 9"></polyline></svg>
</button>
<div class="sub-accordion-body">
<div class="settings-form">
<div class="form-row">
<div class="form-group">
<label>Legal Business Name</label>
<input class="form-input" name="legal_name" required="" type="text"/>
</div>
<div class="form-group">
<label>DBA (optional)</label>
<input class="form-input" name="dba" type="text"/>
</div>
</div>
<div class="form-row three-col">
<div class="form-group">
<label>FEIN / EIN</label>
<input class="form-input" name="ein" type="text"/>
</div>
<div class="form-group">
<label>DUNS Number (optional)</label>
<input class="form-input" name="duns" type="text"/>
</div>
<div class="form-group">
<label>SAM.gov UEI</label>
<input class="form-input" name="uei" type="text"/>
</div>
</div>
<div class="form-row three-col">
<div class="form-group">
<label>Business Type</label>
<select class="form-select" name="business_type">
<option value="">Select</option>
<option>LLC</option>
<option>Corporation</option>
<option>Sole Proprietor</option>
<option>Partnership</option>
<option>Nonprofit</option>
<option>Other</option>
</select>
</div>
<div class="form-group">
<label>State of Incorporation</label>
<select class="form-select" name="state_incorp">
<option value="">Select state</option>
<option value="AL">Alabama</option>
<option value="AK">Alaska</option>
<option value="AZ">Arizona</option>
<option value="AR">Arkansas</option>
<option value="CA">California</option>
<option value="CO">Colorado</option>
<option value="CT">Connecticut</option>
<option value="DE">Delaware</option>
<option value="DC">District of Columbia</option>
<option value="FL">Florida</option>
<option value="GA">Georgia</option>
<option value="HI">Hawaii</option>
<option value="ID">Idaho</option>
<option value="IL">Illinois</option>
<option value="IN">Indiana</option>
<option value="IA">Iowa</option>
<option value="KS">Kansas</option>
<option value="KY">Kentucky</option>
<option value="LA">Louisiana</option>
<option value="ME">Maine</option>
<option value="MD">Maryland</option>
<option value="MA">Massachusetts</option>
<option value="MI">Michigan</option>
<option value="MN">Minnesota</option>
<option value="MS">Mississippi</option>
<option value="MO">Missouri</option>
<option value="MT">Montana</option>
<option value="NE">Nebraska</option>
<option value="NV">Nevada</option>
<option value="NH">New Hampshire</option>
<option value="NJ">New Jersey</option>
<option value="NM">New Mexico</option>
<option value="NY">New York</option>
<option value="NC">North Carolina</option>
<option value="ND">North Dakota</option>
<option value="OH">Ohio</option>
<option value="OK">Oklahoma</option>
<option value="OR">Oregon</option>
<option value="PA">Pennsylvania</option>
<option value="RI">Rhode Island</option>
<option value="SC">South Carolina</option>
<option value="SD">South Dakota</option>
<option value="TN">Tennessee</option>
<option value="TX">Texas</option>
<option value="UT">Utah</option>
<option value="VT">Vermont</option>
<option value="VA">Virginia</option>
<option value="WA">Washington</option>
<option value="WV">West Virginia</option>
<option value="WI">Wisconsin</option>
<option value="WY">Wyoming</option>
</select>
</div>
<div class="form-group">
<label>Year Founded</label>
<input class="form-input" max="2100" min="1800" name="year_founded" type="number"/>
</div>
</div>
<div class="form-row three-col">
<div class="form-group">
<label>Number of Employees (Full-Time)</label>
<input class="form-input" min="0" name="employee_count_ft" type="number"/>
</div>
<div class="form-group">
<label>Number of Employees (Part-Time)</label>
<input class="form-input" min="0" name="employee_count_pt" type="number"/>
</div>
<div class="form-group">
<label>CAGE Code</label>
<input class="form-input" name="cage_code" placeholder="5-character code" type="text"/>
</div>
</div>
<div class="form-row three-col">
<div class="form-group">
<label>Annual Revenue (Current Year)</label>
<input class="form-input" name="revenue_current" placeholder="$X,XXX,XXX" type="text"/>
</div>
<div class="form-group">
<label>Annual Revenue (Prior Year)</label>
<input class="form-input" name="revenue_prior" placeholder="$X,XXX,XXX" type="text"/>
</div>
<div class="form-group">
<label>GSA Schedule Number (if applicable)</label>
<input class="form-input" name="gsa_schedule" type="text"/>
</div>
</div>
<div class="form-row three-col">
<div class="form-group">
<label>Ohio Secretary of State Registration Number</label>
<input class="form-input" name="ohio_reg" type="text"/>
</div>
<div class="form-group">
<label>Ohio "Good Standing" Status</label>
<div class="toggle-row">
<label class="toggle">
<input name="ohio_good_standing" type="checkbox"/>
<span class="toggle-slider"></span>
</label>
<span class="toggle-label">In Good Standing</span>
</div>
</div>
<div class="form-group">
<label>Upload - Ohio Certificate of Good Standing</label>
<div class="file-upload-container">
<div class="file-existing" data-file-existing="ohio_certificate" style="display:none;">
<div class="file-existing-preview" data-file-preview="ohio_certificate" style="display:none;"></div>
<div class="file-existing-info">
<svg fill="none" height="20" stroke="currentColor" stroke-width="2" viewbox="0 0 24 24" width="20">
<path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
<polyline points="14 2 14 8 20 8"></polyline>
</svg>
<div class="file-existing-details">
<span class="file-existing-name" data-file-name="ohio_certificate">—</span>
<span class="file-existing-meta">Uploaded previously</span>
</div>
</div>
<div class="file-existing-actions">
<a class="file-existing-download" data-file-download="ohio_certificate" href="#" rel="noopener" style="display:none;" target="_blank" title="Download">
<svg fill="none" height="16" stroke="currentColor" stroke-width="2" viewbox="0 0 24 24" width="16">
<path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
<polyline points="7 10 12 15 17 10"></polyline>
<line x1="12" x2="12" y1="15" y2="3"></line>
</svg>
</a>
<button class="file-existing-replace" data-file-replace="ohio_certificate" title="Replace" type="button">
<svg fill="none" height="16" stroke="currentColor" stroke-width="2" viewbox="0 0 24 24" width="16">
<polyline points="1 4 1 10 7 10"></polyline>
<path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"></path>
</svg>
</button>
</div>
</div>
<div class="file-upload-area" data-file-upload="ohio_certificate">
<input accept=".pdf,.jpg,.jpeg,.png,.doc,.docx" class="form-input file-input" hidden="" id="upload-ohio_certificate" name="ohio_certificate" type="file"/>
<label class="file-upload-label" for="upload-ohio_certificate">
<svg fill="none" height="24" stroke="currentColor" stroke-width="2" viewbox="0 0 24 24" width="24">
<path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
<polyline points="17 8 12 3 7 8"></polyline>
<line x1="12" x2="12" y1="3" y2="15"></line>
</svg>
<span class="upload-text">Upload certificate</span>
<span class="upload-hint">PDF, JPG, PNG, DOCX (max 25MB)</span>
</label>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sub-accordion-item">
<button aria-expanded="false" class="sub-accordion-header" type="button">
<span>Business Addresses</span>
<svg fill="none" height="16" stroke="currentColor" stroke-width="2" viewbox="0 0 24 24" width="16"><polyline points="6 9 12 15 18 9"></polyline></svg>
</button>
<div class="sub-accordion-body">
<div class="settings-form">
<div class="form-group">
<label>Headquarters Address</label>
<input class="form-input" name="hq_address" type="text"/>
</div>
<div class="form-group">
<label>Mailing Address (if different)</label>
<input class="form-input" name="mailing_address" type="text"/>
</div>
<div class="form-row three-col">
<div class="form-group">
<label>City</label>
<input class="form-input" name="city" type="text"/>
</div>
<div class="form-group">
<label>State</label>
<select class="form-select" name="state">
<option value="">Select state</option>
<option value="AL">Alabama</option>
<option value="AK">Alaska</option>
<option value="AZ">Arizona</option>
<option value="AR">Arkansas</option>
<option value="CA">California</option>
<option value="CO">Colorado</option>
<option value="CT">Connecticut</option>
<option value="DE">Delaware</option>
<option value="DC">District of Columbia</option>
<option value="FL">Florida</option>
<option value="GA">Georgia</option>
<option value="HI">Hawaii</option>
<option value="ID">Idaho</option>
<option value="IL">Illinois</option>
<option value="IN">Indiana</option>
<option value="IA">Iowa</option>
<option value="KS">Kansas</option>
<option value="KY">Kentucky</option>
<option value="LA">Louisiana</option>
<option value="ME">Maine</option>
<option value="MD">Maryland</option>
<option value="MA">Massachusetts</option>
<option value="MI">Michigan</option>
<option value="MN">Minnesota</option>
<option value="MS">Mississippi</option>
<option value="MO">Missouri</option>
<option value="MT">Montana</option>
<option value="NE">Nebraska</option>
<option value="NV">Nevada</option>
<option value="NH">New Hampshire</option>
<option value="NJ">New Jersey</option>
<option value="NM">New Mexico</option>
<option value="NY">New York</option>
<option value="NC">North Carolina</option>
<option value="ND">North Dakota</option>
<option value="OH">Ohio</option>
<option value="OK">Oklahoma</option>
<option value="OR">Oregon</option>
<option value="PA">Pennsylvania</option>
<option value="RI">Rhode Island</option>
<option value="SC">South Carolina</option>
<option value="SD">South Dakota</option>
<option value="TN">Tennessee</option>
<option value="TX">Texas</option>
<option value="UT">Utah</option>
<option value="VT">Vermont</option>
<option value="VA">Virginia</option>
<option value="WA">Washington</option>
<option value="WV">West Virginia</option>
<option value="WI">Wisconsin</option>
<option value="WY">Wyoming</option>
</select>
</div>
<div class="form-group">
<label>Zip Code</label>
<input class="form-input" name="zip" type="text"/>
</div>
</div>
<div class="form-row three-col">
<div class="form-group">
<label>Company Website</label>
<input class="form-input" name="website" placeholder="https://" type="url"/>
</div>
<div class="form-group">
<label>General Business Email</label>
<input class="form-input" name="business_email" type="email"/>
</div>
<div class="form-group">
<label>Billing / AP Email</label>
<input class="form-input" name="billing_email" type="email"/>
</div>
</div>
</div>
</div>
</div>
<div class="sub-accordion-item">
<button aria-expanded="false" class="sub-accordion-header" type="button">
<span>Primary Contacts</span>
<svg fill="none" height="16" stroke="currentColor" stroke-width="2" viewbox="0 0 24 24" width="16"><polyline points="6 9 12 15 18 9"></polyline></svg>
</button>
<div class="sub-accordion-body">
<div class="contact-grid">
<div class="contact-card">
<div class="contact-label">Primary Representative</div>
<div class="form-row">
<div class="form-group">
<label>Full Name</label>
<input class="form-input" name="primary_name" type="text"/>
</div>
<div class="form-group">
<label>Job Title</label>
<input class="form-input" name="primary_title" type="text"/>
</div>
</div>
<div class="form-row">
<div class="form-group">
<label>Email</label>
<input class="form-input" name="primary_email" type="email"/>
</div>
<div class="form-group">
<label>Phone</label>
<input class="form-input" name="primary_phone" type="tel"/>
</div>
</div>
</div>
<div class="contact-card">
<div class="contact-label">Secondary Representative (optional)</div>
<div class="form-row">
<div class="form-group">
<label>Full Name</label>
<input class="form-input" name="secondary_name" type="text"/>
</div>
<div class="form-group">
<label>Job Title</label>
<input class="form-input" name="secondary_title" type="text"/>
</div>
</div>
<div class="form-row">
<div class="form-group">
<label>Email</label>
<input class="form-input" name="secondary_email" type="email"/>
</div>
<div class="form-group">
<label>Phone</label>
<input class="form-input" name="secondary_phone" type="tel"/>
</div>
</div>
</div>
<div class="contact-card">
<div class="contact-label">Bid Submission Contact (if different)</div>
<div class="form-row">
<div class="form-group">
<label>Full Name</label>
<input class="form-input" name="bid_name" type="text"/>
</div>
<div class="form-group">
<label>Job Title</label>
<input class="form-input" name="bid_title" type="text"/>
</div>
</div>
<div class="form-row">
<div class="form-group">
<label>Email</label>
<input class="form-input" name="bid_email" type="email"/>
</div>
<div class="form-group">
<label>Phone</label>
<input class="form-input" name="bid_phone" type="tel"/>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</section>
<section class="profile-panel">
<div class="panel-header">
<div class="panel-title">
<span class="panel-icon">2</span>
<h3>Certifications &amp; Compliance</h3>
</div>
<span class="panel-toggle">+</span>
</div>
<div class="panel-content">
<div class="sub-accordion">
<div class="sub-accordion-item open">
<button aria-expanded="true" class="sub-accordion-header" type="button">
<span>Business Classification &amp; Diversity</span>
<svg fill="none" height="16" stroke="currentColor" stroke-width="2" viewbox="0 0 24 24" width="16"><polyline points="6 9 12 15 18 9"></polyline></svg>
</button>
<div class="sub-accordion-body">
<div class="settings-form">
<div class="form-row">
<div class="form-group">
<label>Is your business certified MBE / WBE / DBE?</label>
<div class="radio-group">
<label class="radio-label">
<input name="cert_status" type="radio" value="yes"/>
<span>Yes</span>
</label>
<label class="radio-label">
<input name="cert_status" type="radio" value="no"/>
<span>No</span>
</label>
</div>
</div>
<div class="form-group">
<label>Certification Type(s)</label>
<div class="checkbox-grid">
<label class="checkbox-label" data-multi-group="cert_types">
<input data-multi="true" name="cert_types" type="checkbox" value="MBE"/>
<span>MBE (Minority Business Enterprise)</span>
</label>
<label class="checkbox-label" data-multi-group="cert_types">
<input data-multi="true" name="cert_types" type="checkbox" value="WBE"/>
<span>WBE (Women Business Enterprise)</span>
</label>
<label class="checkbox-label" data-multi-group="cert_types">
<input data-multi="true" name="cert_types" type="checkbox" value="DBE"/>
<span>DBE (Disadvantaged Business Enterprise)</span>
</label>
<label class="checkbox-label" data-multi-group="cert_types">
<input data-multi="true" name="cert_types" type="checkbox" value="SDVOSB"/>
<span>SDVOSB (Service-Disabled Veteran)</span>
</label>
<label class="checkbox-label" data-multi-group="cert_types">
<input data-multi="true" name="cert_types" type="checkbox" value="HUBZone"/>
<span>HUBZone</span>
</label>
<label class="checkbox-label" data-multi-group="cert_types">
<input data-multi="true" name="cert_types" type="checkbox" value="8(a)"/>
<span>8(a) Certified</span>
</label>
<label class="checkbox-label" data-multi-group="cert_types">
<input data-multi="true" name="cert_types" type="checkbox" value="Other"/>
<span>Other</span>
</label>
</div>
</div>
<div class="form-group">
<label>NAICS Codes (comma-separated)</label>
<input class="form-input" name="naics_codes" placeholder="541330, 541512, 541611" type="text"/>
<span class="form-hint">Primary business classification codes</span>
</div>
</div>
<div class="form-row three-col">
<div class="form-group">
<label>Certification Number</label>
<input class="form-input" name="cert_number" type="text"/>
</div>
<div class="form-group">
<label>Certification Expiration Date</label>
<input class="form-input" name="cert_expiry" type="date"/>
</div>
<div class="form-group">
<label>Upload - Certification Documents</label>
<div class="file-upload-area">
<input accept=".pdf,.jpg,.jpeg,.png,.doc,.docx" class="form-input file-input" hidden="" id="upload-cert_upload" name="cert_upload" required="" type="file"/>
<label class="file-upload-label" for="upload-cert_upload">
<svg fill="none" height="24" stroke="currentColor" stroke-width="2" viewbox="0 0 24 24" width="24">
<path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
<polyline points="17 8 12 3 7 8"></polyline>
<line x1="12" x2="12" y1="3" y2="15"></line>
</svg>
<span class="upload-text">Upload certification documents</span>
<span class="upload-hint">PDF, JPG, PNG, DOCX (max 25MB)</span>
</label>
</div>
<a class="file-link" data-file-link="cert_upload" href="#" rel="noopener" style="display:none;" target="_blank"></a>
</div>
</div>
</div>
</div>
</div>
<div class="sub-accordion-item">
<button aria-expanded="false" class="sub-accordion-header" type="button">
<span>Tax &amp; Legal Compliance</span>
<svg fill="none" height="16" stroke="currentColor" stroke-width="2" viewbox="0 0 24 24" width="16"><polyline points="6 9 12 15 18 9"></polyline></svg>
</button>
<div class="sub-accordion-body">
<div class="checkbox-list">
<label class="checkbox-item">
<input name="attest_wage_theft" type="checkbox"/>
<span>Complies with Wage Theft Prevention Policies</span>
</label>
<label class="checkbox-item">
<input name="attest_income_tax" type="checkbox"/>
<span>Complies with Columbus Income Tax Withholding</span>
</label>
<label class="checkbox-item">
<input name="attest_campaign" type="checkbox"/>
<span>Certifies campaign contribution compliance (ORC 3517.13)</span>
</label>
<label class="checkbox-item">
<input name="attest_public_records" type="checkbox"/>
<span>Acknowledges public records disclosure requirements</span>
</label>
<label class="checkbox-item">
<input name="attest_eo_clause" type="checkbox"/>
<span>Accepts Equal Opportunity Clause</span>
</label>
</div>
</div>
</div>
</div>
</div>
</section>
<section class="profile-panel">
<div class="panel-header">
<div class="panel-title">
<span class="panel-icon">3</span>
<h3>Experience &amp; References</h3>
</div>
<span class="panel-toggle">+</span>
</div>
<div class="panel-content">
<div class="sub-accordion">
<div class="sub-accordion-item open">
<button aria-expanded="true" class="sub-accordion-header" type="button">
<span>Experience &amp; Capability Statement</span>
<svg fill="none" height="16" stroke="currentColor" stroke-width="2" viewbox="0 0 24 24" width="16"><polyline points="6 9 12 15 18 9"></polyline></svg>
</button>
<div class="sub-accordion-body">
<div class="settings-form">
<div class="form-row three-col">
<div class="form-group">
<label>Years of Experience</label>
<input class="form-input" min="0" name="years_experience" type="number"/>
</div>
<div class="form-group">
<label>Warranty Service Capabilities</label>
<input class="form-input" name="warranty" placeholder="Response times, onsite coverage" type="text"/>
</div>
<div class="form-group">
<label>Manufacturer Relationships (optional)</label>
<input class="form-input" name="manufacturers" placeholder="OEMs, authorized dealer status" type="text"/>
</div>
</div>
<div class="form-group">
<label>Description of Company Experience</label>
<textarea class="form-input" name="experience" rows="3"></textarea>
</div>
<div class="form-group">
<label>Description of Services / Product Offerings</label>
<textarea class="form-input" name="offerings" rows="3"></textarea>
</div>
<div class="form-row">
<div class="form-group">
<label>Upload - Capability Statement PDF</label>
<div class="file-upload-area">
<input accept=".pdf,.jpg,.jpeg,.png,.doc,.docx" class="form-input file-input" hidden="" id="upload-capability_statement" name="capability_statement" required="" type="file"/>
<label class="file-upload-label" for="upload-capability_statement">
<svg fill="none" height="24" stroke="currentColor" stroke-width="2" viewbox="0 0 24 24" width="24">
<path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
<polyline points="17 8 12 3 7 8"></polyline>
<line x1="12" x2="12" y1="3" y2="15"></line>
</svg>
<span class="upload-text">Upload capability statement</span>
<span class="upload-hint">PDF, JPG, PNG, DOCX (max 25MB)</span>
</label>
</div>
<a class="file-link" data-file-link="capability_statement" href="#" rel="noopener" style="display:none;" target="_blank"></a>
</div>
<div class="form-group">
<label>Upload - Product Catalogs / Literature (optional)</label>
<div class="file-upload-area">
<input accept=".pdf,.jpg,.jpeg,.png,.doc,.docx" class="form-input file-input" hidden="" id="upload-product_catalogs" name="product_catalogs" type="file"/>
<label class="file-upload-label" for="upload-product_catalogs">
<svg fill="none" height="24" stroke="currentColor" stroke-width="2" viewbox="0 0 24 24" width="24">
<path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
<polyline points="17 8 12 3 7 8"></polyline>
<line x1="12" x2="12" y1="3" y2="15"></line>
</svg>
<span class="upload-text">Upload product catalogs</span>
<span class="upload-hint">PDF, JPG, PNG, DOCX (max 25MB)</span>
</label>
</div>
<a class="file-link" data-file-link="product_catalogs" href="#" rel="noopener" style="display:none;" target="_blank"></a>
</div>
</div>
</div>
</div>
</div>
<div class="sub-accordion-item">
<button aria-expanded="false" class="sub-accordion-header" type="button">
<span>References <span class="required-count">(3 required, up to 5)</span></span>
<svg fill="none" height="16" stroke="currentColor" stroke-width="2" viewbox="0 0 24 24" width="16"><polyline points="6 9 12 15 18 9"></polyline></svg>
</button>
<div class="sub-accordion-body">
<div class="references-container" id="referencesContainer"><div class="reference-entry" data-index="1">
<div class="reference-header">
<h4>Reference #1</h4>
<button class="remove-btn" onclick="removeReference(this)" style="display: none;" type="button">Remove</button>
</div>
<div class="form-row">
<div class="form-group">
<label>Business Name <span class="required">*</span></label>
<input class="form-input" name="ref1_business" placeholder="Client company name" type="text"/>
</div>
<div class="form-group">
<label>Contact Name <span class="required">*</span></label>
<input class="form-input" name="ref1_contact" placeholder="Contact person" type="text"/>
</div>
</div>
<div class="form-row">
<div class="form-group">
<label>Title</label>
<input class="form-input" name="ref1_title" placeholder="Job title" type="text"/>
</div>
<div class="form-group">
<label>Email <span class="required">*</span></label>
<input class="form-input" name="ref1_email" placeholder="contact@company.com" type="email"/>
</div>
</div>
<div class="form-row">
<div class="form-group">
<label>Phone <span class="required">*</span></label>
<input class="form-input" name="ref1_phone" placeholder="(xxx) xxx-xxxx" type="tel"/>
</div>
<div class="form-group">
<label>Address</label>
<input class="form-input" name="ref1_address" placeholder="City, State" type="text"/>
</div>
</div>
<div class="form-group">
<label>Project / Contract Description <span class="required">*</span></label>
<textarea class="form-textarea" name="ref1_description" placeholder="Brief description of work performed..." rows="2"></textarea>
</div>
<div class="form-row">
<div class="form-group">
<label>Contract Amount</label>
<input class="form-input" name="ref1_amount" placeholder="$XXX,XXX (optional)" type="text"/>
</div>
<div class="form-group">
<label>Contract Dates</label>
<input class="form-input" name="ref1_dates" placeholder="MM/YYYY - MM/YYYY" type="text"/>
</div>
</div>
<div class="form-group">
<label>Reference Letter</label>
<div class="file-upload-area small">
<input accept=".pdf,.jpg,.png,.docx" hidden="" id="ref1_letter" name="ref1_letter" type="file"/>
<label class="file-upload-label small" for="ref1_letter">
<span class="upload-text">Upload letter (optional)</span>
</label>
</div>
</div>
</div><div class="reference-entry" data-index="2">
<div class="reference-header">
<h4>Reference #2</h4>
<button class="remove-btn" onclick="removeReference(this)" type="button">Remove</button>
</div>
<div class="form-row">
<div class="form-group">
<label>Business Name <span class="required">*</span></label>
<input class="form-input" name="ref2_business" placeholder="Client company name" type="text"/>
</div>
<div class="form-group">
<label>Contact Name <span class="required">*</span></label>
<input class="form-input" name="ref2_contact" placeholder="Contact person" type="text"/>
</div>
</div>
<div class="form-row">
<div class="form-group">
<label>Title</label>
<input class="form-input" name="ref2_title" placeholder="Job title" type="text"/>
</div>
<div class="form-group">
<label>Email <span class="required">*</span></label>
<input class="form-input" name="ref2_email" placeholder="contact@company.com" type="email"/>
</div>
</div>
<div class="form-row">
<div class="form-group">
<label>Phone <span class="required">*</span></label>
<input class="form-input" name="ref2_phone" placeholder="(xxx) xxx-xxxx" type="tel"/>
</div>
<div class="form-group">
<label>Address</label>
<input class="form-input" name="ref2_address" placeholder="City, State" type="text"/>
</div>
</div>
<div class="form-group">
<label>Project / Contract Description <span class="required">*</span></label>
<textarea class="form-textarea" name="ref2_description" placeholder="Brief description of work performed..." rows="2"></textarea>
</div>
<div class="form-row">
<div class="form-group">
<label>Contract Amount</label>
<input class="form-input" name="ref2_amount" placeholder="$XXX,XXX (optional)" type="text"/>
</div>
<div class="form-group">
<label>Contract Dates</label>
<input class="form-input" name="ref2_dates" placeholder="MM/YYYY - MM/YYYY" type="text"/>
</div>
</div>
<div class="form-group">
<label>Reference Letter</label>
<div class="file-upload-area small">
<input accept=".pdf,.jpg,.png,.docx" hidden="" id="ref2_letter" name="ref2_letter" type="file"/>
<label class="file-upload-label small" for="ref1_letter">
<span class="upload-text">Upload letter (optional)</span>
</label>
</div>
</div>
</div><div class="reference-entry" data-index="3">
<div class="reference-header">
<h4>Reference #3</h4>
<button class="remove-btn" onclick="removeReference(this)" type="button">Remove</button>
</div>
<div class="form-row">
<div class="form-group">
<label>Business Name <span class="required">*</span></label>
<input class="form-input" name="ref3_business" placeholder="Client company name" type="text"/>
</div>
<div class="form-group">
<label>Contact Name <span class="required">*</span></label>
<input class="form-input" name="ref3_contact" placeholder="Contact person" type="text"/>
</div>
</div>
<div class="form-row">
<div class="form-group">
<label>Title</label>
<input class="form-input" name="ref3_title" placeholder="Job title" type="text"/>
</div>
<div class="form-group">
<label>Email <span class="required">*</span></label>
<input class="form-input" name="ref3_email" placeholder="contact@company.com" type="email"/>
</div>
</div>
<div class="form-row">
<div class="form-group">
<label>Phone <span class="required">*</span></label>
<input class="form-input" name="ref3_phone" placeholder="(xxx) xxx-xxxx" type="tel"/>
</div>
<div class="form-group">
<label>Address</label>
<input class="form-input" name="ref3_address" placeholder="City, State" type="text"/>
</div>
</div>
<div class="form-group">
<label>Project / Contract Description <span class="required">*</span></label>
<textarea class="form-textarea" name="ref3_description" placeholder="Brief description of work performed..." rows="2"></textarea>
</div>
<div class="form-row">
<div class="form-group">
<label>Contract Amount</label>
<input class="form-input" name="ref3_amount" placeholder="$XXX,XXX (optional)" type="text"/>
</div>
<div class="form-group">
<label>Contract Dates</label>
<input class="form-input" name="ref3_dates" placeholder="MM/YYYY - MM/YYYY" type="text"/>
</div>
</div>
<div class="form-group">
<label>Reference Letter</label>
<div class="file-upload-area small">
<input accept=".pdf,.jpg,.png,.docx" hidden="" id="ref3_letter" name="ref3_letter" type="file"/>
<label class="file-upload-label small" for="ref1_letter">
<span class="upload-text">Upload letter (optional)</span>
</label>
</div>
</div>
</div></div>
<button class="add-entry-btn" id="addReferenceBtn" type="button"><span>+</span> Add Another Reference</button>
</div>
</div>
<div class="sub-accordion-item">
<button aria-expanded="false" class="sub-accordion-header" type="button">
<span>Subcontractor Information (optional)</span>
<svg fill="none" height="16" stroke="currentColor" stroke-width="2" viewbox="0 0 24 24" width="16"><polyline points="6 9 12 15 18 9"></polyline></svg>
</button>
<div class="sub-accordion-body">
<div class="repeatable-list" id="subcontractorList">
<div class="repeatable-card subcontractor-entry" data-index="1">
<div class="subcontractor-header reference-header">
<h4>Subcontractor #1</h4>
<button class="remove-btn" onclick="removeSubcontractor(this)" style="display: none;" type="button">Remove</button>
</div>
<div class="form-row three-col">
<div class="form-group">
<label>Subcontractor Business Name</label>
<input class="form-input" name="sub1_name" type="text"/>
</div>
<div class="form-group">
<label>Contact Person</label>
<input class="form-input" name="sub1_contact" type="text"/>
</div>
<div class="form-group">
<label>Email</label>
<input class="form-input" name="sub1_email" type="email"/>
</div>
</div>
<div class="form-row three-col">
<div class="form-group">
<label>Phone</label>
<input class="form-input" name="sub1_phone" type="tel"/>
</div>
<div class="form-group">
<label>Address</label>
<input class="form-input" name="sub1_address" type="text"/>
</div>
<div class="form-group">
<label>Work Performed / Scope</label>
<input class="form-input" name="sub1_scope" type="text"/>
</div>
</div>
<div class="form-row">
<div class="form-group">
<label>Contract Compliance Certification Number (if applicable)</label>
<input class="form-input" name="sub1_compliance" type="text"/>
</div>
<div class="form-group">
<label>Upload - Subcontractor Compliance Certificate (optional)</label>
<div class="file-upload-area">
<input accept=".pdf,.jpg,.jpeg,.png,.doc,.docx" class="form-input file-input" hidden="" id="upload-sub1_certificate" name="sub1_certificate" type="file"/>
<label class="file-upload-label" for="upload-sub1_certificate">
<svg fill="none" height="24" stroke="currentColor" stroke-width="2" viewbox="0 0 24 24" width="24">
<path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
<polyline points="17 8 12 3 7 8"></polyline>
<line x1="12" x2="12" y1="3" y2="15"></line>
</svg>
<span class="upload-text">Upload compliance certificate</span>
<span class="upload-hint">PDF, JPG, PNG, DOCX (max 25MB)</span>
</label>
</div>
<a class="file-link" data-file-link="sub1_certificate" href="#" rel="noopener" style="display:none;" target="_blank"></a>
</div>
</div>
</div>
</div>
<button class="add-row-btn" id="addSubcontractorBtn" type="button">+ Add Subcontractor</button>
</div>
</div>
</div>
</div>
</section>
<section class="profile-panel">
<div class="panel-header">
<div class="panel-title">
<span class="panel-icon">4</span>
<h3>Insurance, Bonding &amp; Safety</h3>
</div>
<span class="panel-toggle">+</span>
</div>
<div class="panel-content">
<div class="sub-accordion">
<div class="sub-accordion-item open">
<button aria-expanded="true" class="sub-accordion-header" type="button">
<span>Insurance, Bonding &amp; Safety</span>
<svg fill="none" height="16" stroke="currentColor" stroke-width="2" viewbox="0 0 24 24" width="16"><polyline points="6 9 12 15 18 9"></polyline></svg>
</button>
<div class="sub-accordion-body">
<div class="settings-form">
<div class="form-row three-col">
<div class="form-group">
<label>General Liability Coverage</label>
<select class="form-select" name="gl_coverage">
<option value="">Select</option>
<option value="yes">Yes</option>
<option value="no">No</option>
</select>
</div>
<div class="form-group">
<label>Workers Compensation Coverage</label>
<select class="form-select" name="wc_coverage">
<option value="">Select</option>
<option value="yes">Yes</option>
<option value="no">No</option>
</select>
</div>
<div class="form-group">
<label>Auto Liability Coverage</label>
<select class="form-select" name="auto_coverage">
<option value="">Select</option>
<option value="yes">Yes</option>
<option value="no">No</option>
</select>
</div>
</div>
<div class="form-row three-col">
<div class="form-group">
<label>Bonding Capacity</label>
<input class="form-input" name="bonding_capacity" type="text"/>
</div>
<div class="form-group">
<label>Bonding Company Name</label>
<input class="form-input" name="bonding_company" type="text"/>
</div>
<div class="form-group">
<label>Upload - Certificate of Insurance</label>
<div class="file-upload-area">
<input accept=".pdf,.jpg,.jpeg,.png,.doc,.docx" class="form-input file-input" hidden="" id="upload-insurance_certificate" name="insurance_certificate" required="" type="file"/>
<label class="file-upload-label" for="upload-insurance_certificate">
<svg fill="none" height="24" stroke="currentColor" stroke-width="2" viewbox="0 0 24 24" width="24">
<path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
<polyline points="17 8 12 3 7 8"></polyline>
<line x1="12" x2="12" y1="3" y2="15"></line>
</svg>
<span class="upload-text">Upload certificate of insurance</span>
<span class="upload-hint">PDF, JPG, PNG, DOCX (max 25MB)</span>
</label>
</div>
<a class="file-link" data-file-link="insurance_certificate" href="#" rel="noopener" style="display:none;" target="_blank"></a>
</div>
</div>
<div class="form-group">
<label>Upload - Bonding Letter (optional)</label>
<div class="file-upload-area">
<input accept=".pdf,.jpg,.jpeg,.png,.doc,.docx" class="form-input file-input" hidden="" id="upload-bonding_letter" name="bonding_letter" type="file"/>
<label class="file-upload-label" for="upload-bonding_letter">
<svg fill="none" height="24" stroke="currentColor" stroke-width="2" viewbox="0 0 24 24" width="24">
<path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
<polyline points="17 8 12 3 7 8"></polyline>
<line x1="12" x2="12" y1="3" y2="15"></line>
</svg>
<span class="upload-text">Upload bonding letter</span>
<span class="upload-hint">PDF, JPG, PNG, DOCX (max 25MB)</span>
</label>
</div>
<a class="file-link" data-file-link="bonding_letter" href="#" rel="noopener" style="display:none;" target="_blank"></a>
</div>
<div class="form-row three-col">
<div class="form-group">
<label>Experience Modification Rate (EMR)</label>
<input class="form-input" name="emr_rate" placeholder="e.g., 0.85" type="text"/>
</div>
<div class="form-group">
<label>OSHA Recordable Incidents (Last 3 Years)</label>
<input class="form-input" min="0" name="osha_incidents" type="number"/>
</div>
<div class="form-group">
<label>Drug-Free Workplace Policy</label>
<select class="form-select" name="drug_free_workplace">
<option value="">Select</option>
<option value="yes">Yes - Policy in Place</option>
<option value="no">No</option>
</select>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</section>
<section class="profile-panel">
<div class="panel-header">
<div class="panel-title">
<span class="panel-icon">5</span>
<h3>Pricing &amp; Delivery</h3>
</div>
<span class="panel-toggle">+</span>
</div>
<div class="panel-content">
<div class="sub-accordion">
<div class="sub-accordion-item open">
<button aria-expanded="true" class="sub-accordion-header" type="button">
<span>Pricing &amp; Delivery Defaults</span>
<svg fill="none" height="16" stroke="currentColor" stroke-width="2" viewbox="0 0 24 24" width="16"><polyline points="6 9 12 15 18 9"></polyline></svg>
</button>
<div class="sub-accordion-body">
<div class="settings-form">
<div class="form-row three-col">
<div class="form-group">
<label>Standard Payment Terms</label>
<select class="form-select" name="payment_terms">
<option value="">Select</option>
<option>Net 15</option>
<option>Net 30</option>
<option>Net 45</option>
<option>Net 60</option>
<option>Net 90</option>
<option>Due on Receipt</option>
<option>Custom</option>
</select>
</div>
<div class="form-group">
<label>Standard Delivery Lead Time</label>
<input class="form-input" name="delivery_time" placeholder="e.g., 10 business days" type="text"/>
</div>
<div class="form-group">
<label>Minimum Order Requirement</label>
<input class="form-input" name="min_order" type="text"/>
</div>
</div>
<div class="form-row">
<div class="form-group">
<label>Default Discount / Markup Structure</label>
<input class="form-input" name="discount_structure" placeholder="Volume discounts, GSA schedules" type="text"/>
</div>
<div class="form-group">
<label>Link to Price List or Website</label>
<input class="form-input" name="price_link" placeholder="https://" type="url"/>
</div>
</div>
<div class="form-group">
<label>Upload - Price List PDF / Catalog</label>
<div class="file-upload-area">
<input accept=".pdf,.jpg,.jpeg,.png,.doc,.docx" class="form-input file-input" hidden="" id="upload-price_list_upload" name="price_list_upload" required="" type="file"/>
<label class="file-upload-label" for="upload-price_list_upload">
<svg fill="none" height="24" stroke="currentColor" stroke-width="2" viewbox="0 0 24 24" width="24">
<path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
<polyline points="17 8 12 3 7 8"></polyline>
<line x1="12" x2="12" y1="3" y2="15"></line>
</svg>
<span class="upload-text">Upload price list or catalog</span>
<span class="upload-hint">PDF, JPG, PNG, DOCX (max 25MB)</span>
</label>
</div>
<a class="file-link" data-file-link="price_list_upload" href="#" rel="noopener" style="display:none;" target="_blank"></a>
</div>
</div>
</div>
</div>
</div>
</div>
</section>
<section class="profile-panel">
<div class="panel-header">
<div class="panel-title">
<span class="panel-icon">6</span>
<h3>Documents &amp; Uploads</h3>
</div>
<span class="panel-toggle">+</span>
</div>
<div class="panel-content">
<div class="sub-accordion">
<div class="sub-accordion-item open">
<button aria-expanded="true" class="sub-accordion-header" type="button">
<span>Documents &amp; Uploads</span>
<svg fill="none" height="16" stroke="currentColor" stroke-width="2" viewbox="0 0 24 24" width="16"><polyline points="6 9 12 15 18 9"></polyline></svg>
</button>
<div class="sub-accordion-body">
<div class="settings-form">
<!-- Add to Certifications & Compliance section -->
<div class="form-row">
<div class="form-group">
<label>Financial Statements (optional)</label>
<div class="file-upload-area">
<input accept=".pdf,.jpg,.jpeg,.png,.doc,.docx" class="form-input file-input" hidden="" id="upload-financial_statements" name="financial_statements" type="file"/>
<label class="file-upload-label" for="upload-financial_statements">
<svg fill="none" height="24" stroke="currentColor" stroke-width="2" viewbox="0 0 24 24" width="24">
<path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
<polyline points="17 8 12 3 7 8"></polyline>
<line x1="12" x2="12" y1="3" y2="15"></line>
</svg>
<span class="upload-text">Upload financial statements</span>
<span class="upload-hint">PDF, JPG, PNG, DOCX (max 25MB)</span>
</label>
</div>
<div class="file-status" data-file-status="financial_statements"></div>
<a class="file-link" data-file-link="financial_statements" href="#" rel="noopener" style="display:none;" target="_blank"></a>
</div>
<div class="form-group">
<label>Debarment Certification (optional)</label>
<div class="file-upload-area">
<input accept=".pdf,.jpg,.jpeg,.png,.doc,.docx" class="form-input file-input" hidden="" id="upload-debarment_certification" name="debarment_certification" type="file"/>
<label class="file-upload-label" for="upload-debarment_certification">
<svg fill="none" height="24" stroke="currentColor" stroke-width="2" viewbox="0 0 24 24" width="24">
<path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
<polyline points="17 8 12 3 7 8"></polyline>
<line x1="12" x2="12" y1="3" y2="15"></line>
</svg>
<span class="upload-text">Upload debarment cert</span>
<span class="upload-hint">PDF, JPG, PNG, DOCX (max 25MB)</span>
</label>
</div>
<div class="file-status" data-file-status="debarment_certification"></div>
<a class="file-link" data-file-link="debarment_certification" href="#" rel="noopener" style="display:none;" target="_blank"></a>
</div>
</div>
<div class="form-row three-col">
<div class="form-group">
<label>Upload - W-9 Form</label>
<div class="file-upload-area">
<input accept=".pdf,.jpg,.jpeg,.png,.doc,.docx" class="form-input file-input" hidden="" id="upload-w9_upload" name="w9_upload" type="file"/>
<label class="file-upload-label" for="upload-w9_upload">
<svg fill="none" height="24" stroke="currentColor" stroke-width="2" viewbox="0 0 24 24" width="24">
<path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
<polyline points="17 8 12 3 7 8"></polyline>
<line x1="12" x2="12" y1="3" y2="15"></line>
</svg>
<span class="upload-text">Upload W-9</span>
<span class="upload-hint">PDF, JPG, PNG, DOCX (max 25MB)</span>
</label>
</div>
<a class="file-link" data-file-link="w9_upload" href="#" rel="noopener" style="display:none;" target="_blank"></a>
</div>
<div class="form-group">
<label>Upload - Business License</label>
<div class="file-upload-area">
<input accept=".pdf,.jpg,.jpeg,.png,.doc,.docx" class="form-input file-input" hidden="" id="upload-business_license" name="business_license" type="file"/>
<label class="file-upload-label" for="upload-business_license">
<svg fill="none" height="24" stroke="currentColor" stroke-width="2" viewbox="0 0 24 24" width="24">
<path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
<polyline points="17 8 12 3 7 8"></polyline>
<line x1="12" x2="12" y1="3" y2="15"></line>
</svg>
<span class="upload-text">Upload business license</span>
<span class="upload-hint">PDF, JPG, PNG, DOCX (max 25MB)</span>
</label>
</div>
<a class="file-link" data-file-link="business_license" href="#" rel="noopener" style="display:none;" target="_blank"></a>
</div>
<div class="form-group">
<label>Upload - Safety Sheets / SDS (if applicable)</label>
<div class="file-upload-area">
<input accept=".pdf,.jpg,.jpeg,.png,.doc,.docx" class="form-input file-input" hidden="" id="upload-safety_sheets" name="safety_sheets" type="file"/>
<label class="file-upload-label" for="upload-safety_sheets">
<svg fill="none" height="24" stroke="currentColor" stroke-width="2" viewbox="0 0 24 24" width="24">
<path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
<polyline points="17 8 12 3 7 8"></polyline>
<line x1="12" x2="12" y1="3" y2="15"></line>
</svg>
<span class="upload-text">Upload safety sheets</span>
<span class="upload-hint">PDF, JPG, PNG, DOCX (max 25MB)</span>
</label>
</div>
<a class="file-link" data-file-link="safety_sheets" href="#" rel="noopener" style="display:none;" target="_blank"></a>
</div>
</div>
<div class="form-row three-col">
<div class="form-group">
<label>Upload - Warranty Information</label>
<div class="file-upload-area">
<input accept=".pdf,.jpg,.jpeg,.png,.doc,.docx" class="form-input file-input" hidden="" id="upload-warranty_info" name="warranty_info" type="file"/>
<label class="file-upload-label" for="upload-warranty_info">
<svg fill="none" height="24" stroke="currentColor" stroke-width="2" viewbox="0 0 24 24" width="24">
<path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
<polyline points="17 8 12 3 7 8"></polyline>
<line x1="12" x2="12" y1="3" y2="15"></line>
</svg>
<span class="upload-text">Upload warranty info</span>
<span class="upload-hint">PDF, JPG, PNG, DOCX (max 25MB)</span>
</label>
</div>
<a class="file-link" data-file-link="warranty_info" href="#" rel="noopener" style="display:none;" target="_blank"></a>
</div>
<div class="form-group">
<label>Upload - Previous Contract PDFs (optional)</label>
<div class="file-upload-area">
<input accept=".pdf,.jpg,.jpeg,.png,.doc,.docx" class="form-input file-input" hidden="" id="upload-previous_contracts" name="previous_contracts" type="file"/>
<label class="file-upload-label" for="upload-previous_contracts">
<svg fill="none" height="24" stroke="currentColor" stroke-width="2" viewbox="0 0 24 24" width="24">
<path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
<polyline points="17 8 12 3 7 8"></polyline>
<line x1="12" x2="12" y1="3" y2="15"></line>
</svg>
<span class="upload-text">Upload previous contracts</span>
<span class="upload-hint">PDF, JPG, PNG, DOCX (max 25MB)</span>
</label>
</div>
<a class="file-link" data-file-link="previous_contracts" href="#" rel="noopener" style="display:none;" target="_blank"></a>
</div>
<div class="form-group">
<label>Upload - Organizational Chart (optional)</label>
<div class="file-upload-area">
<input accept=".pdf,.jpg,.jpeg,.png,.doc,.docx" class="form-input file-input" hidden="" id="upload-org_chart" name="org_chart" type="file"/>
<label class="file-upload-label" for="upload-org_chart">
<svg fill="none" height="24" stroke="currentColor" stroke-width="2" viewbox="0 0 24 24" width="24">
<path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
<polyline points="17 8 12 3 7 8"></polyline>
<line x1="12" x2="12" y1="3" y2="15"></line>
</svg>
<span class="upload-text">Upload org chart</span>
<span class="upload-hint">PDF, JPG, PNG, DOCX (max 25MB)</span>
</label>
</div>
<a class="file-link" data-file-link="org_chart" href="#" rel="noopener" style="display:none;" target="_blank"></a>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</section>
<section class="profile-panel">
<div class="panel-header">
<div class="panel-title">
<span class="panel-icon">7</span>
<h3>Authorized Signer</h3>
</div>
<span class="panel-toggle">+</span>
</div>
<div class="panel-content">
<div class="sub-accordion">
<div class="sub-accordion-item open">
<button aria-expanded="true" class="sub-accordion-header" type="button">
<span>Authorized Signer Information</span>
<svg fill="none" height="16" stroke="currentColor" stroke-width="2" viewbox="0 0 24 24" width="16"><polyline points="6 9 12 15 18 9"></polyline></svg>
</button>
<div class="sub-accordion-body">
<div class="settings-form">
<div class="form-row three-col">
<div class="form-group">
<label>Authorized Signer Name</label>
<input class="form-input" name="signer_name" type="text"/>
</div>
<div class="form-group">
<label>Title</label>
<input class="form-input" name="signer_title" type="text"/>
</div>
<div class="form-group">
<label>Signature Block Text</label>
<input class="form-input" name="signature_block" placeholder="Name, Title, Company, Date" type="text"/>
</div>
</div>
<div class="form-row">
<div class="form-group">
<label>Digital Signature File (optional)</label>
<div class="file-upload-container">
<div class="file-existing" data-file-existing="digital_signature" style="display:none;">
<div class="file-existing-preview" data-file-preview="digital_signature" style="display:none;"></div>
<div class="file-existing-info">
<svg fill="none" height="20" stroke="currentColor" stroke-width="2" viewbox="0 0 24 24" width="20">
<path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
<polyline points="14 2 14 8 20 8"></polyline>
</svg>
<div class="file-existing-details">
<span class="file-existing-name" data-file-name="digital_signature">—</span>
<span class="file-existing-meta">Uploaded previously</span>
</div>
</div>
<div class="file-existing-actions">
<a class="file-existing-download" data-file-download="digital_signature" href="#" rel="noopener" target="_blank" title="Download">
<svg fill="none" height="16" stroke="currentColor" stroke-width="2" viewbox="0 0 24 24" width="16">
<path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
<polyline points="7 10 12 15 17 10"></polyline>
<line x1="12" x2="12" y1="15" y2="3"></line>
</svg>
</a>
<button class="file-existing-replace" data-file-replace="digital_signature" title="Replace" type="button">
<svg fill="none" height="16" stroke="currentColor" stroke-width="2" viewbox="0 0 24 24" width="16">
<polyline points="1 4 1 10 7 10"></polyline>
<path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"></path>
</svg>
</button>
</div>
</div>
<div class="file-upload-area" data-file-upload="digital_signature">
<input accept=".pdf,.jpg,.jpeg,.png,.doc,.docx" class="form-input file-input" hidden="" id="upload-digital_signature" name="digital_signature" type="file"/>
<label class="file-upload-label" for="upload-digital_signature">
<svg fill="none" height="24" stroke="currentColor" stroke-width="2" viewbox="0 0 24 24" width="24">
<path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
<polyline points="17 8 12 3 7 8"></polyline>
<line x1="12" x2="12" y1="3" y2="15"></line>
</svg>
<span class="upload-text">Upload digital signature</span>
<span class="upload-hint">PDF, JPG, PNG, DOCX (max 25MB)</span>
</label>
</div>
</div>
</div>
<div class="form-group">
<label>Upload - Signature Image (optional)</label>
<div class="file-upload-container">
<div class="file-existing" data-file-existing="signature_image" style="display:none;">
<div class="file-existing-preview" data-file-preview="signature_image" style="display:none;"></div>
<div class="file-existing-info">
<svg fill="none" height="20" stroke="currentColor" stroke-width="2" viewbox="0 0 24 24" width="20">
<path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
<polyline points="14 2 14 8 20 8"></polyline>
</svg>
<div class="file-existing-details">
<span class="file-existing-name" data-file-name="signature_image">—</span>
<span class="file-existing-meta">Uploaded previously</span>
</div>
</div>
<div class="file-existing-actions">
<a class="file-existing-download" data-file-download="signature_image" href="#" rel="noopener" target="_blank" title="Download">
<svg fill="none" height="16" stroke="currentColor" stroke-width="2" viewbox="0 0 24 24" width="16">
<path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
<polyline points="7 10 12 15 17 10"></polyline>
<line x1="12" x2="12" y1="15" y2="3"></line>
</svg>
</a>
<button class="file-existing-replace" data-file-replace="signature_image" title="Replace" type="button">
<svg fill="none" height="16" stroke="currentColor" stroke-width="2" viewbox="0 0 24 24" width="16">
<polyline points="1 4 1 10 7 10"></polyline>
<path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"></path>
</svg>
</button>
</div>
</div>
<div class="file-upload-area" data-file-upload="signature_image">
<input accept=".pdf,.jpg,.jpeg,.png,.doc,.docx" class="form-input file-input" hidden="" id="upload-signature_image" name="signature_image" type="file"/>
<label class="file-upload-label" for="upload-signature_image">
<svg fill="none" height="24" stroke="currentColor" stroke-width="2" viewbox="0 0 24 24" width="24">
<path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
<polyline points="17 8 12 3 7 8"></polyline>
<line x1="12" x2="12" y1="3" y2="15"></line>
</svg>
<span class="upload-text">Upload signature image</span>
<span class="upload-hint">PDF, JPG, PNG, DOCX (max 25MB)</span>
</label>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</section></div>
</div>
</div>
<div class="tab-content" id="tab-billing">
<div class="billing-overview fade-in">
<div class="billing-plan-card">
<div class="billing-plan-header">
<div class="billing-plan-badge">Current Plan</div>
<div class="billing-plan-info">
<h2 id="billingPlanName">--</h2>
<p id="billingPlanCopy"></p>
</div>
<div class="billing-plan-price">
<span class="price-big" id="billingPlanPrice">--</span>
<span class="price-period" id="billingPlanPeriod"></span>
</div>
</div>
<div class="billing-plan-body">
<div class="billing-stat">
<span class="billing-stat-value" id="billingAnnualCost">--</span>
<span class="billing-stat-label">Annual cost</span>
</div>
<div class="billing-stat">
<span class="billing-stat-value" id="billingNextBilling">--</span>
<span class="billing-stat-label">Next billing</span>
</div>
<div class="billing-stat">
<span class="billing-stat-value" id="billingCycle">--</span>
<span class="billing-stat-label">Billing cycle</span>
</div>
</div>
<div class="billing-plan-actions">
<a class="btn-primary" href="/billing" id="billingUpgradeBtn">Compare Plans</a>
<button class="btn-secondary" id="billingManageBtn" type="button">Manage / cancel subscription</button>
</div>
</div>
</div>
<div class="settings-section fade-in stagger-1">
<div class="settings-header">
<h3>Payment Method</h3>
<p>Manage your payment information.</p>
</div>
<div class="payment-methods" id="billingPaymentMethods">
<div class="muted">Loading payment method...</div>
</div>
</div>
<div class="settings-section fade-in stagger-2">
<div class="settings-header">
<h3>Billing History</h3>
<p>Download invoices and view past payments.</p>
</div>
<div class="billing-table">
<div class="billing-row header">
<span>Date</span>
<span>Description</span>
<span>Amount</span>
<span>Status</span>
<span></span>
</div>
<div id="billingHistoryRows">
<div class="billing-row">
<span class="muted">Loading invoices...</span>
</div>
</div>
</div>
</div>
</div>
<div class="tab-content" id="tab-team">
<div class="team-header fade-in">
<div class="team-header-info">
<h2>Team Members</h2>
<p>Manage your team and their permissions.</p>
</div>
<div class="team-header-stats">
<div class="team-stat">
<span class="team-stat-value" id="teamCount">--</span>
<span class="team-stat-label">Members</span>
</div>
<div class="team-stat">
<span class="team-stat-value" id="teamAvailable">--</span>
<span class="team-stat-label">Available</span>
</div>
</div>
<button class="btn-primary" id="teamInviteBtn">
<svg fill="none" height="16" stroke="currentColor" stroke-width="2" viewbox="0 0 24 24" width="16">
<line x1="12" x2="12" y1="5" y2="19"></line>
<line x1="5" x2="19" y1="12" y2="12"></line>
</svg>
                Invite Member
              </button>
</div>
<div class="team-grid fade-in stagger-1" id="teamGrid">
<div class="muted">Loading team...</div>
</div>
<div class="settings-section fade-in stagger-2">
<div class="settings-header">
<h3>Pending Invitations</h3>
</div>
<div class="pending-invites" id="pendingInvites">
<div class="muted">No pending invites.</div>
</div>
</div>
</div>
<div class="tab-content" id="tab-notifications">
<div class="settings-section fade-in">
<div class="settings-header">
<h3>Alert Preferences</h3>
<p>Configure how and when you receive bid opportunity alerts.</p>
</div>
<div class="settings-form">
<div class="form-row">
<div class="form-group">
<label for="alertDigestFrequency">Digest Frequency</label>
<select class="form-select" id="alertDigestFrequency">
<option value="daily">Daily (last 24h of activity)</option>
<option value="weekly">Weekly (last 7 days)</option>
<option value="none">No email yet</option>
</select>
<span class="form-hint">Choose how often we email new opportunities.</span>
</div>
<div class="form-group">
<label for="alertSmsPhone">SMS Phone</label>
<input class="form-input" id="alertSmsPhone" placeholder="(555) 555-5555" type="text"/>
<span class="form-hint">SMS alerts require a paid plan.</span>
</div>
</div>
<div class="form-group">
<label>Agency Filters</label>
<div class="agency-grid" id="alertAgencyFilters">
<label class="agency-choice"><input type="checkbox" value="City of Columbus"/>City of Columbus</label>
<label class="agency-choice"><input type="checkbox" value="City of Grove City"/>City of Grove City</label>
<label class="agency-choice"><input type="checkbox" value="City of Gahanna"/>City of Gahanna</label>
<label class="agency-choice"><input type="checkbox" value="City of Marysville"/>City of Marysville</label>
<label class="agency-choice"><input type="checkbox" value="City of Whitehall"/>City of Whitehall</label>
<label class="agency-choice"><input type="checkbox" value="City of Grandview Heights"/>City of Grandview Heights</label>
<label class="agency-choice"><input type="checkbox" value="city of Worthington"/>city of Worthington</label>
<label class="agency-choice"><input type="checkbox" value="Solid Waste Authority of Central Ohio (SWACO)"/>Solid Waste Authority of Central Ohio (SWACO)</label>
<label class="agency-choice"><input type="checkbox" value="Central Ohio Transit Authority (COTA)"/>Central Ohio Transit Authority (COTA)</label>
<label class="agency-choice"><input type="checkbox" value="Franklin County, Ohio"/>Franklin County, Ohio</label>
<label class="agency-choice"><input type="checkbox" value="City of Westerville"/>City of Westerville</label>
<label class="agency-choice"><input type="checkbox" value="Columbus Metropolitan Library"/>Columbus Metropolitan Library</label>
<label class="agency-choice"><input type="checkbox" value="Columbus Metropolitan Housing Authority"/>Columbus Metropolitan Housing Authority</label>
<label class="agency-choice"><input type="checkbox" value="Columbus and Franklin County Metro Parks"/>Columbus and Franklin County Metro Parks</label>
<label class="agency-choice"><input type="checkbox" value="Columbus Regional Airport Authority (CRAA)"/>Columbus Regional Airport Authority (CRAA)</label>
<label class="agency-choice"><input type="checkbox" value="Mid-Ohio Regional Planning Commission (MORPC)"/>Mid-Ohio Regional Planning Commission (MORPC)</label>
<label class="agency-choice"><input type="checkbox" value="Dublin City Schools"/>Dublin City Schools</label>
<label class="agency-choice"><input type="checkbox" value="Village of Minerva Park"/>Village of Minerva Park</label>
<label class="agency-choice"><input type="checkbox" value="City of New Albany"/>City of New Albany</label>
<label class="agency-choice"><input type="checkbox" value="Ohio Buys"/>Ohio Buys</label>
</div>
<span class="form-hint">If you leave all unchecked, you'll get everything we track.</span>
</div>
<div class="form-group">
<label class="checkbox-label">
<input id="alertSmsOptIn" type="checkbox"/>
Send me SMS alerts (due soon + digest)
</label>
<span class="form-hint">Carrier rates may apply.</span>
</div>
<div class="form-actions">
<button class="btn-primary" id="saveAlertPrefs" type="button">Save Preferences</button>
<span class="form-hint" id="alertPrefsStatus" aria-live="polite"></span>
</div>
</div>
</div>
<div class="settings-section fade-in">
<div class="settings-header">
<h3>Email Notifications</h3>
<p>Choose what updates you want to receive via email.</p>
</div>
<div class="notification-list">
<div class="notification-item">
<div class="notification-info">
<h4>Bid Deadline Reminders</h4>
<p>Get notified 24 hours and 1 hour before deadlines</p>
</div>
<label class="toggle">
<input checked="" type="checkbox"/>
<span class="toggle-slider"></span>
</label>
</div>
<div class="notification-item">
<div class="notification-info">
<h4>New Opportunities</h4>
<p>Daily digest of new bids matching your preferences</p>
</div>
<label class="toggle">
<input checked="" type="checkbox"/>
<span class="toggle-slider"></span>
</label>
</div>
<div class="notification-item">
<div class="notification-info">
<h4>Team Activity</h4>
<p>Updates when team members make changes to bids</p>
</div>
<label class="toggle">
<input checked="" type="checkbox"/>
<span class="toggle-slider"></span>
</label>
</div>
<div class="notification-item">
<div class="notification-info">
<h4>Weekly Summary</h4>
<p>Weekly report of your bid activity and wins</p>
</div>
<label class="toggle">
<input type="checkbox"/>
<span class="toggle-slider"></span>
</label>
</div>
<div class="notification-item">
<div class="notification-info">
<h4>Product Updates</h4>
<p>New features and improvements to EasyRFP</p>
</div>
<label class="toggle">
<input type="checkbox"/>
<span class="toggle-slider"></span>
</label>
</div>
</div>
</div>
<div class="settings-section fade-in stagger-1">
<div class="settings-header">
<h3>Push Notifications</h3>
<p>Real-time alerts in your browser.</p>
</div>
<div class="notification-list">
<div class="notification-item">
<div class="notification-info">
<h4>Urgent Deadlines</h4>
<p>Immediate alerts for bids due within 2 hours</p>
</div>
<label class="toggle">
<input checked="" type="checkbox"/>
<span class="toggle-slider"></span>
</label>
</div>
<div class="notification-item">
<div class="notification-info">
<h4>Team Messages</h4>
<p>Notifications for new messages and mentions</p>
</div>
<label class="toggle">
<input checked="" type="checkbox"/>
<span class="toggle-slider"></span>
</label>
</div>
<div class="notification-item">
<div class="notification-info">
<h4>Document Updates</h4>
<p>Alerts when documents are uploaded or modified</p>
</div>
<label class="toggle">
<input type="checkbox"/>
<span class="toggle-slider"></span>
</label>
</div>
</div>
</div>
</div>
<div class="tab-content" id="tab-security">
<div class="settings-section fade-in">
<div class="settings-header">
<h3>Password</h3>
<p>Update your password to keep your account secure.</p>
</div>
<div class="settings-form">
<div class="form-group">
<label>Current Password</label>
<div class="password-input-wrapper">
<input class="form-input" placeholder="Enter current password" type="password"/>
<button class="password-toggle" type="button">
<svg fill="none" height="18" stroke="currentColor" stroke-width="2" viewbox="0 0 24 24" width="18">
<path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
<circle cx="12" cy="12" r="3"></circle>
</svg>
</button>
</div>
</div>
<div class="form-group">
<label>New Password</label>
<div class="password-input-wrapper">
<input class="form-input" placeholder="Enter new password" type="password"/>
<button class="password-toggle" type="button">
<svg fill="none" height="18" stroke="currentColor" stroke-width="2" viewbox="0 0 24 24" width="18">
<path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
<circle cx="12" cy="12" r="3"></circle>
</svg>
</button>
</div>
<div class="password-strength">
<div class="strength-bar">
<div class="strength-fill" style="width: 0%;"></div>
</div>
<span class="strength-label">Enter a password</span>
</div>
</div>
<div class="form-group">
<label>Confirm New Password</label>
<input class="form-input" placeholder="Confirm new password" type="password"/>
</div>
<div class="form-actions">
<button class="btn-primary">Update Password</button>
</div>
</div>
</div>
<div class="settings-section fade-in stagger-1">
<div class="settings-header">
<h3>Two-Factor Authentication</h3>
<p>Add an extra layer of security to your account.</p>
</div>
<div class="two-factor-card">
<div class="two-factor-icon">
<svg fill="none" height="32" stroke="currentColor" stroke-width="2" viewbox="0 0 24 24" width="32">
<rect height="11" rx="2" ry="2" width="18" x="3" y="11"></rect>
<path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
</svg>
</div>
<div class="two-factor-info">
<h4>Two-Factor Authentication is OFF</h4>
<p>Protect your account with an additional security layer using your phone.</p>
</div>
<button class="btn-primary">Enable 2FA</button>
</div>
</div>
<div class="settings-section fade-in stagger-2">
<div class="settings-header">
<h3>Active Sessions</h3>
<p>Manage devices where you're currently logged in.</p>
</div>
<div class="sessions-list">
<div class="session-item current">
<div class="session-icon">
<svg fill="none" height="20" stroke="currentColor" stroke-width="2" viewbox="0 0 24 24" width="20">
<rect height="14" rx="2" ry="2" width="20" x="2" y="3"></rect>
<line x1="8" x2="16" y1="21" y2="21"></line>
<line x1="12" x2="12" y1="17" y2="21"></line>
</svg>
</div>
<div class="session-info">
<span class="session-device">MacBook Pro - Chrome</span>
<span class="session-location">Columbus, OH • Current session</span>
</div>
<span class="session-current-badge">This device</span>
</div>
<div class="session-item">
<div class="session-icon">
<svg fill="none" height="20" stroke="currentColor" stroke-width="2" viewbox="0 0 24 24" width="20">
<rect height="20" rx="2" ry="2" width="14" x="5" y="2"></rect>
<line x1="12" x2="12.01" y1="18" y2="18"></line>
</svg>
</div>
<div class="session-info">
<span class="session-device">iPhone 14 - Safari</span>
<span class="session-location">Columbus, OH • Last active 2 hours ago</span>
</div>
<button class="btn-danger-ghost">Revoke</button>
</div>
</div>
<button class="btn-danger-outline full-width">
<svg fill="none" height="16" stroke="currentColor" stroke-width="2" viewbox="0 0 24 24" width="16">
<path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
<polyline points="16 17 21 12 16 7"></polyline>
<line x1="21" x2="9" y1="12" y2="12"></line>
</svg>
                Sign Out All Other Sessions
              </button>
</div>
<div class="settings-section danger-zone fade-in stagger-3">
<div class="settings-header">
<h3>Danger Zone</h3>
<p>Irreversible and destructive actions.</p>
</div>
<div class="danger-actions">
<div class="danger-action">
<div class="danger-info">
<h4>Export Your Data</h4>
<p>Download a copy of all your data including bids, documents, and settings.</p>
</div>
<button class="btn-secondary">Export Data</button>
</div>
<div class="danger-action">
<div class="danger-info">
<h4>Delete Account</h4>
<p>Permanently delete your account and all associated data. This cannot be undone.</p>
</div>
<button class="btn-danger">Delete Account</button>
</div>
</div>
</div>
</div>
</div>
</main>
</div>
</div>
<script>
    document.addEventListener('DOMContentLoaded', function() {
      const scrollProgress = document.getElementById('scrollProgress');
      const content = document.querySelector('.content');
      
      if (content && scrollProgress) {
        content.addEventListener('scroll', () => {
          const scrollTop = content.scrollTop;
          const scrollHeight = content.scrollHeight - content.clientHeight;
          const progress = (scrollTop / scrollHeight) * 100;
          scrollProgress.style.width = progress + '%';
        });
      }

      const tabs = document.querySelectorAll('.account-tab');
      const tabContents = document.querySelectorAll('.tab-content');

      function showTab(tabId, options = {}) {
        if (!tabId) return;
        const updateHash = options.updateHash === true;
        tabs.forEach(t => t.classList.remove('active'));
        const activeTab = document.querySelector(`.account-tab[data-tab="${tabId}"]`);
        if (activeTab) activeTab.classList.add('active');

        tabContents.forEach(content => {
          content.classList.remove('active');
          if (content.id === `tab-${tabId}`) {
            content.classList.add('active');
            content.querySelectorAll('.fade-in').forEach((el, i) => {
              el.style.opacity = '0';
              el.style.transform = 'translateY(16px)';
              setTimeout(() => {
                el.style.opacity = '1';
                el.style.transform = 'translateY(0)';
              }, 50 * i);
            });
          }
        });

        if (updateHash) {
          history.replaceState(null, '', `#tab-${tabId}`);
        }
        if (tabId === 'notifications') {
          loadAlertPreferences();
        }
      }

      tabs.forEach(tab => {
        tab.addEventListener('click', () => {
          const tabId = tab.dataset.tab;
          showTab(tabId, { updateHash: true });
        });
      });

      function handleHashNavigation() {
        const hash = window.location.hash || '';
        if (!hash.startsWith('#tab-')) return;
        const tabId = hash.replace('#tab-', '');
        if (!document.querySelector(`.account-tab[data-tab="${tabId}"]`)) return;
        showTab(tabId);
      }
      window.addEventListener('hashchange', handleHashNavigation);

      setTimeout(() => {
        document.querySelectorAll('.fade-in').forEach((el, i) => {
          setTimeout(() => {
            el.style.opacity = '1';
            el.style.transform = 'translateY(0)';
          }, 50 * i);
        });
      }, 100);

      document.querySelectorAll('.toggle input').forEach(toggle => {
        toggle.addEventListener('change', function() {
          const label = this.closest('.notification-item').querySelector('h4').textContent;
          console.log(`${label}: ${this.checked ? 'enabled' : 'disabled'}`);
        });
      });

      document.querySelectorAll('.password-toggle').forEach(btn => {
        btn.addEventListener('click', function() {
          const input = this.previousElementSibling;
          const type = input.type === 'password' ? 'text' : 'password';
          input.type = type;
          this.classList.toggle('active');
        });
      });

      const newPasswordInput = document.querySelector('input[placeholder="Enter new password"]');
      if (newPasswordInput) {
        newPasswordInput.addEventListener('input', function() {
          const password = this.value;
          const strengthFill = document.querySelector('.strength-fill');
          const strengthLabel = document.querySelector('.strength-label');
          
          let strength = 0;
          if (password.length >= 8) strength += 25;
          if (/[A-Z]/.test(password)) strength += 25;
          if (/[0-9]/.test(password)) strength += 25;
          if (/[^A-Za-z0-9]/.test(password)) strength += 25;
          
          strengthFill.style.width = strength + '%';
          
          if (strength === 0) {
            strengthLabel.textContent = 'Enter a password';
            strengthFill.style.background = '#94a3b8';
          } else if (strength <= 25) {
            strengthLabel.textContent = 'Weak';
            strengthFill.style.background = '#ef4444';
          } else if (strength <= 50) {
            strengthLabel.textContent = 'Fair';
            strengthFill.style.background = '#f59e0b';
          } else if (strength <= 75) {
            strengthLabel.textContent = 'Good';
            strengthFill.style.background = '#22c55e';
          } else {
            strengthLabel.textContent = 'Strong';
            strengthFill.style.background = 'var(--primary-gradient)';
          }
        });
      }

      document.getElementById('signOutBtn')?.addEventListener('click', function() {
        if (confirm('Are you sure you want to sign out?')) {
          window.location.href = '/logout';
        }
      });

      // Dynamic wiring -------------------------------------------------
      const planPricing = {
        free: { amount: '$0', period: '/month', limit: 1 },
        starter: { amount: '$29', period: '/month', limit: 3 },
        professional: { amount: '$99', period: '/month', limit: 5 },
        enterprise: { amount: '$299', period: '/month', limit: 50 },
      };
      const fileFields = [
        'ohio_certificate',
        'cert_upload',
        'capability_statement',
        'product_catalogs',
        'ref1_letter',
        'ref2_letter',
        'ref3_letter',
        'ref4_letter',
        'ref5_letter',
        'sub1_certificate',
        'sub2_certificate',
        'sub3_certificate',
        'sub4_certificate',
        'sub5_certificate',
        'insurance_certificate',
        'bonding_letter',
        'price_list_upload',
        'w9_upload',
        'business_license',
        'safety_sheets',
        'warranty_info',
        'previous_contracts',
        'org_chart',
        'digital_signature',
        'signature_image',
        // NEW FIELDS:
        'financial_statements',
        'debarment_certification',
        'labor_compliance_cert',
        'conflict_of_interest',
        'references_combined',
      ];
      const panelSaveStoreKey = 'company_profile_panel_saves';
      const personalDraftKey = 'account_personal_info_draft';
      let personalSnapshot = {};

      function getCSRF() {
        try { return (document.cookie.match(/(?:^|; )csrftoken=([^;]+)/) || [])[1] || ''; } catch (_) { return ''; }
      }

      function ensureFormFieldAttributes() {
        const usedIds = new Set();
        document.querySelectorAll('[id]').forEach((el) => {
          if (el.id) usedIds.add(el.id);
        });

        const slugify = (value) => String(value || '')
          .toLowerCase()
          .replace(/[^a-z0-9]+/g, '-')
          .replace(/^-+|-+$/g, '');

        let autoIndex = 0;
        const makeUniqueId = (base) => {
          let candidate = base || `field-${autoIndex++}`;
          while (usedIds.has(candidate)) {
            candidate = `${base}-${autoIndex++}`;
          }
          usedIds.add(candidate);
          return candidate;
        };

        document.querySelectorAll('input, select, textarea').forEach((field) => {
          if (field.tagName === 'INPUT') {
            const type = (field.getAttribute('type') || '').toLowerCase();
            if (['hidden', 'submit', 'button', 'reset'].includes(type)) return;
          }

          if (!field.id) {
            const source = field.getAttribute('name')
              || field.getAttribute('data-field')
              || field.getAttribute('value')
              || field.getAttribute('placeholder')
              || field.getAttribute('type')
              || field.tagName.toLowerCase();
            const slug = slugify(source) || `field-${autoIndex++}`;
            field.id = makeUniqueId(`field-${slug}`);
          }

          if (!field.name) {
            field.name = field.getAttribute('data-field') || field.id;
          }
        });

        document.querySelectorAll('.form-group').forEach((group) => {
          const label = group.querySelector('label');
          if (!label || label.getAttribute('for')) return;
          if (label.querySelector('input, select, textarea')) return;
          const field = group.querySelector('input, select, textarea');
          if (!field || !field.id) return;
          label.setAttribute('for', field.id);
        });
      }

      let alertPrefsLoaded = false;
      let alertPrefsLoading = false;

      function setAlertPrefsStatus(message, tone = '') {
        const status = document.getElementById('alertPrefsStatus');
        if (!status) return;
        status.textContent = message || '';
        if (tone === 'success') {
          status.style.color = '#16a34a';
        } else if (tone === 'error') {
          status.style.color = '#ef4444';
        } else {
          status.style.color = '';
        }
      }

      function getAlertAgencySelections() {
        return Array.from(document.querySelectorAll('#alertAgencyFilters input[type="checkbox"]'))
          .filter((el) => el.checked)
          .map((el) => el.value);
      }

      function applyAlertPreferences(data = {}) {
        const freqEl = document.getElementById('alertDigestFrequency');
        const smsPhoneEl = document.getElementById('alertSmsPhone');
        const smsOptInEl = document.getElementById('alertSmsOptIn');
        if (freqEl) {
          const freq = String(data.digest_frequency || 'daily').toLowerCase();
          freqEl.value = ['daily', 'weekly', 'none'].includes(freq) ? freq : 'daily';
        }
        if (smsPhoneEl) smsPhoneEl.value = data.sms_phone || '';
        if (smsOptInEl) smsOptInEl.checked = Boolean(data.sms_opt_in);
        const selected = new Set(Array.isArray(data.agency_filter) ? data.agency_filter : []);
        document.querySelectorAll('#alertAgencyFilters input[type="checkbox"]').forEach((el) => {
          el.checked = selected.has(el.value);
        });
      }

      async function loadAlertPreferences(force = false) {
        if (alertPrefsLoading) return;
        if (alertPrefsLoaded && !force) return;
        const freqEl = document.getElementById('alertDigestFrequency');
        if (!freqEl) return;
        alertPrefsLoading = true;
        setAlertPrefsStatus('Loading preferences...');
        try {
          const res = await fetch('/api/me/preferences', { credentials: 'include' });
          if (!res.ok) throw new Error('load failed');
          const data = await res.json();
          applyAlertPreferences(data);
          alertPrefsLoaded = true;
          setAlertPrefsStatus('');
        } catch (_) {
          setAlertPrefsStatus('Could not load preferences.', 'error');
        } finally {
          alertPrefsLoading = false;
        }
      }

      async function saveAlertPreferences() {
        const btn = document.getElementById('saveAlertPrefs');
        const freqEl = document.getElementById('alertDigestFrequency');
        const smsPhoneEl = document.getElementById('alertSmsPhone');
        const smsOptInEl = document.getElementById('alertSmsOptIn');
        if (!freqEl) return;
        btn && (btn.disabled = true);
        setAlertPrefsStatus('');
        try {
          const payload = {
            digest_frequency: freqEl.value,
            agency_filter: getAlertAgencySelections(),
            sms_phone: (smsPhoneEl?.value || '').trim(),
            sms_opt_in: Boolean(smsOptInEl?.checked),
          };
          const res = await fetch('/api/me/preferences', {
            method: 'POST',
            credentials: 'include',
            headers: {
              'Content-Type': 'application/json',
              'X-CSRF-Token': getCSRF(),
            },
            body: JSON.stringify(payload),
          });
          if (!res.ok) throw new Error('save failed');
          alertPrefsLoaded = true;
          setAlertPrefsStatus('Saved successfully!', 'success');
        } catch (_) {
          setAlertPrefsStatus('Could not save preferences.', 'error');
        } finally {
          btn && (btn.disabled = false);
        }
      }

      const inviteModal = document.getElementById('teamInviteModal');
      const inviteEmailInput = document.getElementById('teamInviteEmail');
      const inviteRoleSelect = document.getElementById('teamInviteRole');
      const inviteStatus = document.getElementById('teamInviteStatus');
      const inviteSendBtn = document.getElementById('teamInviteSend');

      function setInviteStatus(message, tone = '') {
        if (!inviteStatus) return;
        inviteStatus.textContent = message || '';
        if (tone === 'success') {
          inviteStatus.style.color = '#16a34a';
        } else if (tone === 'error') {
          inviteStatus.style.color = '#ef4444';
        } else {
          inviteStatus.style.color = '';
        }
      }

      function openInviteModal() {
        if (!inviteModal) return;
        inviteModal.style.display = 'flex';
        setInviteStatus('');
        if (inviteEmailInput) {
          inviteEmailInput.value = '';
          inviteEmailInput.focus();
        }
        if (inviteRoleSelect) inviteRoleSelect.value = 'member';
      }

      function closeInviteModal() {
        if (!inviteModal) return;
        inviteModal.style.display = 'none';
      }

      async function sendTeamInvite() {
        const email = (inviteEmailInput?.value || '').trim().toLowerCase();
        if (!email) {
          setInviteStatus('Enter a valid email address.', 'error');
          return;
        }
        inviteSendBtn && (inviteSendBtn.disabled = true);
        setInviteStatus('');
        try {
          const res = await fetch('/api/team/invite', {
            method: 'POST',
            credentials: 'include',
            headers: { 'Content-Type': 'application/json', 'X-CSRF-Token': getCSRF() },
            body: JSON.stringify({ email, role: inviteRoleSelect?.value || 'member' }),
          });
          const data = await res.json().catch(() => ({}));
          if (!res.ok) {
            throw new Error(data?.detail || 'Could not send invite.');
          }
          setInviteStatus(`Invite sent to ${email}.`, 'success');
          await loadAccount();
          setTimeout(closeInviteModal, 600);
        } catch (err) {
          setInviteStatus(err?.message || 'Could not send invite.', 'error');
        } finally {
          inviteSendBtn && (inviteSendBtn.disabled = false);
        }
      }

      inviteModal?.addEventListener('click', (event) => {
        if (event.target === inviteModal) closeInviteModal();
      });
      document.getElementById('teamInviteClose')?.addEventListener('click', closeInviteModal);
      document.getElementById('teamInviteCancel')?.addEventListener('click', closeInviteModal);
      inviteSendBtn?.addEventListener('click', sendTeamInvite);
      inviteEmailInput?.addEventListener('keydown', (event) => {
        if (event.key === 'Enter') {
          event.preventDefault();
          sendTeamInvite();
        }
      });

      function initials(str) {
        if (!str) return '??';
        const parts = str.trim().split(/\s+/);
        if (parts.length >= 2) return (parts[0][0] + parts[1][0]).toUpperCase();
        if (str.includes('@')) return str.split('@')[0].slice(0, 2).toUpperCase();
        return str.slice(0, 2).toUpperCase();
      }

      function formatMonthYear(iso) {
        if (!iso) return '';
        const d = new Date(iso);
        if (isNaN(d.getTime())) return '';
        return d.toLocaleString('en-US', { month: 'short', year: 'numeric' });
      }

      function personalFormValues() {
        return {
          first_name: (document.getElementById('profileFirstName')?.value || '').trim(),
          last_name: (document.getElementById('profileLastName')?.value || '').trim(),
          email: (document.getElementById('profileEmail')?.value || '').trim(),
          phone: (document.getElementById('profilePhone')?.value || '').trim(),
          title: (document.getElementById('profileJobTitle')?.value || '').trim(),
        };
      }

      function applyPersonalValues(values = {}) {
        const { first_name, last_name, email, phone, title } = values;
        const pf = document.getElementById('profileFirstName');
        const pl = document.getElementById('profileLastName');
        const pe = document.getElementById('profileEmail');
        const pp = document.getElementById('profilePhone');
        const pj = document.getElementById('profileJobTitle');
        if (pf && first_name !== undefined && first_name !== null) pf.value = first_name;
        if (pl && last_name !== undefined && last_name !== null) pl.value = last_name;
        if (pe && email !== undefined && email !== null) pe.value = email;
        if (pp && phone !== undefined && phone !== null) pp.value = phone;
        if (pj && title !== undefined && title !== null) pj.value = title;
      }

      function loadPersonalDraft(preferWhenMissing = false) {
        try {
          const raw = localStorage.getItem(personalDraftKey);
          if (!raw) return;
          const draft = JSON.parse(raw);
          if (preferWhenMissing) {
            const current = personalFormValues();
            applyPersonalValues({
              first_name: current.first_name || draft.first_name,
              last_name: current.last_name || draft.last_name,
              email: current.email || draft.email,
              phone: current.phone || draft.phone,
              title: current.title || draft.title,
            });
          } else {
            applyPersonalValues(draft);
          }
        } catch (_) { /* ignore */ }
      }

      function savePersonalDraft(values) {
        try {
          localStorage.setItem(personalDraftKey, JSON.stringify(values));
        } catch (_) { /* ignore */ }
      }

      function ensureFileContainer(field) {
        const input = document.querySelector(`input[name="${field}"]`);
        if (!input) return null;
        const uploadArea = input.closest('.file-upload-area') || input.closest('.file-upload-area.small') || input.parentElement;
        if (!uploadArea) return null;
        const existingWrap = uploadArea.closest('.file-upload-container');
        if (existingWrap) return existingWrap.querySelector('[data-file-existing]');
        const group = uploadArea.closest('.form-group') || uploadArea.parentElement;
        if (!group) return null;
        const container = document.createElement('div');
        container.className = 'file-upload-container';
        const existingDiv = createExistingTemplate(field);
        uploadArea.dataset.fileUpload = field;
        container.appendChild(existingDiv);
        container.appendChild(uploadArea);
        const legacyLink = group.querySelector(`[data-file-link="${field}"]`);
        if (legacyLink) legacyLink.remove();
        const status = group.querySelector(`[data-file-status="${field}"]`);
        if (status) status.remove();
        group.appendChild(container);
        return existingDiv;
      }

      function isImageUrl(url) {
        if (!url) return false;
        const urlWithoutQuery = String(url).split('?')[0];
        return (
          /\.(png|jpe?g|gif|webp|bmp|svg)$/i.test(urlWithoutQuery) ||
          /[?&](content-type|type)=image/i.test(String(url))
        );
      }

      function extractFilename(str) {
        if (!str) return '';
        const legacyMatch = String(str).match(/filename=['"]?([^'")]+)['"]?/i);
        if (legacyMatch && legacyMatch[1]) return legacyMatch[1];
        const parts = String(str).split(/[\\/]/);
        return parts.pop() || '';
      }

      function showExistingFile(field, name, url) {
        // Ensure container exists
        let existingDiv = document.querySelector(`[data-file-existing="${field}"]`);
        let uploadDiv = document.querySelector(`[data-file-upload="${field}"]`);
        
        // If elements don't exist, create them
        if (!existingDiv || !uploadDiv) {
          const created = ensureFileContainer(field);
          if (!created) return; // No input found for this field
          existingDiv = document.querySelector(`[data-file-existing="${field}"]`);
          uploadDiv = document.querySelector(`[data-file-upload="${field}"]`);
        }
        
        if (!existingDiv || !uploadDiv) return;

        const nameEl = document.querySelector(`[data-file-name="${field}"]`);
        const downloadLink = document.querySelector(`[data-file-download="${field}"]`);
        const previewEl = document.querySelector(`[data-file-preview="${field}"]`);

        // Determine display name
        let displayName = (name || '').trim();
        if (!displayName) displayName = extractFilename(url) || extractFilename(name);
        if (!displayName && url) displayName = 'Uploaded file';
        
        const hasSomething = Boolean(displayName || url);

        if (hasSomething) {
          // Show existing file, hide upload area
          existingDiv.style.display = 'flex';
          uploadDiv.style.display = 'none';
          
          // Update filename
          if (nameEl) nameEl.textContent = displayName || 'Uploaded file';
          
          // Update download link
          if (downloadLink) {
            if (url) {
              downloadLink.href = url;
              downloadLink.style.display = 'flex';
            } else {
              downloadLink.style.display = 'none';
            }
          }
          
          // Update preview
          if (previewEl) {
            if (url && isImageUrl(url)) {
              const img = document.createElement('img');
              img.src = url;
              img.alt = displayName || 'Preview';
              img.loading = 'lazy';
              img.onerror = function() {
                const ext = (displayName.split('.').pop() || '').toUpperCase();
                previewEl.innerHTML = `<div class="file-preview-icon">${ext || 'FILE'}</div>`;
                previewEl.style.display = 'flex';
              };
              previewEl.innerHTML = '';
              previewEl.appendChild(img);
              previewEl.style.display = 'flex';
            } else {
              // Show file type icon
              const ext = (displayName.split('.').pop() || '').toUpperCase();
              previewEl.innerHTML = `<div class="file-preview-icon">${ext || 'FILE'}</div>`;
              previewEl.style.display = 'flex';
            }
          }
        } else {
          // No file - show upload area, hide existing
          existingDiv.style.display = 'none';
          uploadDiv.style.display = 'block';
          if (previewEl) {
            previewEl.innerHTML = '';
            previewEl.style.display = 'none';
          }
        }
        
        // Rebind replace button for this field
        bindFileReplaceButtons();
      }

      function setFileWarning(field, message) {
        const existingDiv = document.querySelector(`[data-file-existing="${field}"]`);
        if (!existingDiv) return;
        const details = existingDiv.querySelector('.file-existing-details');
        if (!details) return;
        let warningEl = details.querySelector(`[data-file-warning="${field}"]`);
        if (!message) {
          if (warningEl) warningEl.remove();
          return;
        }
        if (!warningEl) {
          warningEl = document.createElement('span');
          warningEl.className = 'file-existing-warning';
          warningEl.dataset.fileWarning = field;
          details.appendChild(warningEl);
        }
        warningEl.textContent = message;
      }

      function setFileExtractionStatus(field, meta = {}, payload = {}) {
        const existingDiv = document.querySelector(`[data-file-existing="${field}"]`);
        if (!existingDiv) return;
        const metaEl = existingDiv.querySelector('.file-existing-meta');
        if (!metaEl) return;

        const storedText = payload?.[`${field}_text`];
        const storedCount = payload?.[`${field}_word_count`];
        const hasText = meta?.has_text !== undefined ? meta.has_text : Boolean(storedText);
        const rawCount = meta?.word_count ?? storedCount;
        const wordCount = Number.isFinite(Number(rawCount)) ? Number(rawCount) : 0;
        const status = meta?.extraction_status ?? payload?.[`${field}_extraction_status`];
        const error = meta?.extraction_error ?? payload?.[`${field}_extraction_error`];

        metaEl.classList.remove('extraction-success', 'extraction-warning', 'extraction-pending');

        if (hasText) {
          metaEl.textContent = wordCount ? `Text extracted - ${wordCount} words` : 'Text extracted';
          metaEl.classList.add('extraction-success');
          return;
        }

        if (error) {
          metaEl.textContent = `Text not extracted - ${error}`;
          metaEl.classList.add('extraction-warning');
          return;
        }

        if (status) {
          metaEl.textContent = 'Text not extracted';
          metaEl.classList.add('extraction-pending');
          return;
        }

        metaEl.textContent = 'Text not extracted';
        metaEl.classList.add('extraction-pending');
      }

      function markFileSelection(input, displayName) {
        if (!input) return;
        const field = input.getAttribute('name');
        const uploadDiv = input.closest('[data-file-upload]');
        const existingDiv = document.querySelector(`[data-file-existing="${field}"]`);
        const label = input.closest('.file-upload-area')?.querySelector('.file-upload-label');
        const text = label?.querySelector('.upload-text');
        const hint = label?.querySelector('.upload-hint');
        
        if (displayName && text) {
          text.textContent = `Uploaded: ${displayName}`;
          text.style.color = '#126a45';
          text.style.fontWeight = '600';
        }
        if (hint) {
          hint.textContent = 'Ready to save';
          hint.style.color = '#126a45';
        }
        if (existingDiv && uploadDiv) {
          existingDiv.style.display = 'none';
          uploadDiv.style.display = 'block';
        }
        if (field) setFileWarning(field, '');
      }

      function createExistingTemplate(field) {
        const existingDiv = document.createElement('div');
        existingDiv.className = 'file-existing';
        existingDiv.dataset.fileExisting = field;
        existingDiv.style.display = 'none';
        existingDiv.innerHTML = `
          <div class="file-existing-preview" data-file-preview="${field}" style="display:none;"></div>
          <div class="file-existing-info">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
              <polyline points="14 2 14 8 20 8"></polyline>
            </svg>
            <div class="file-existing-details">
              <span class="file-existing-name" data-file-name="${field}">—</span>
              <span class="file-existing-meta">Uploaded previously</span>
            </div>
          </div>
          <div class="file-existing-actions">
            <a class="file-existing-download" data-file-download="${field}" href="#" target="_blank" rel="noopener" title="Download" style="display:none;">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                <polyline points="7 10 12 15 17 10"></polyline>
                <line x1="12" y1="15" x2="12" y2="3"></line>
              </svg>
            </a>
            <button type="button" class="file-existing-replace" data-file-replace="${field}" title="Replace">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="1 4 1 10 7 10"></polyline>
                <path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"></path>
              </svg>
            </button>
          </div>
        `;
        return existingDiv;
      }

      function upgradeFileInputs() {
        document.querySelectorAll('input[type="file"][name]').forEach((input) => {
          const field = input.getAttribute('name');
          if (!field) return;
          const uploadArea = input.closest('.file-upload-area') || input.closest('.file-upload-area.small') || input.parentElement;
          if (!uploadArea) return;
          
          // Already upgraded? ensure data attribute exists and skip
          if (uploadArea.closest('.file-upload-container')) {
            if (!uploadArea.dataset.fileUpload) {
              uploadArea.dataset.fileUpload = field;
            }
            return;
          }
          
          uploadArea.dataset.fileUpload = field;
          const group = uploadArea.closest('.form-group') || uploadArea.parentElement;
          if (!group) return;
          
          // Create container and structure
          const container = document.createElement('div');
          container.className = 'file-upload-container';
          const existingDiv = createExistingTemplate(field);
          
          // Insert before uploadArea to preserve position, then move uploadArea inside
          uploadArea.parentNode.insertBefore(container, uploadArea);
          container.appendChild(existingDiv);
          container.appendChild(uploadArea);
          
          // Clean up legacy elements
          const legacyLink = group.querySelector(`[data-file-link="${field}"]`);
          if (legacyLink) legacyLink.remove();
          const status = group.querySelector(`[data-file-status="${field}"]`);
          if (status) status.remove();
        });
      }

      function bindFileReplaceButtons() {
        document.querySelectorAll('[data-file-replace]').forEach((btn) => {
          if (btn.dataset.boundReplace === '1') return;
          btn.dataset.boundReplace = '1';
          btn.addEventListener('click', () => {
            const field = btn.dataset.fileReplace;
            const existingDiv = document.querySelector(`[data-file-existing="${field}"]`);
            const uploadDiv = document.querySelector(`[data-file-upload="${field}"]`);
            const input = document.querySelector(`input[name="${field}"]`);
            if (existingDiv) existingDiv.style.display = 'none';
            if (uploadDiv) uploadDiv.style.display = 'block';
            if (input) input.click();
          });
        });
      }

      function loadPanelSaveTimes() {
        try {
          const raw = localStorage.getItem(panelSaveStoreKey);
          return raw ? JSON.parse(raw) : {};
        } catch (_) {
          return {};
        }
      }

      function savePanelSaveTimes(map) {
        try {
          localStorage.setItem(panelSaveStoreKey, JSON.stringify(map));
        } catch (_) { /* ignore */ }
      }

      function formatSaveTime(ts) {
        if (!ts) return '';
        const d = new Date(ts);
        if (isNaN(d.getTime())) return '';
        
        // Use consistent, readable format instead of toLocaleString()
        const now = new Date();
        const diffMs = now - d;
        const diffMins = Math.floor(diffMs / 60000);
        
        if (diffMins < 1) return 'just now';
        if (diffMins < 60) return `${diffMins}m ago`;
        
        const diffHours = Math.floor(diffMins / 60);
        if (diffHours < 24) return `${diffHours}h ago`;
        
        const diffDays = Math.floor(diffHours / 24);
        if (diffDays < 7) return `${diffDays}d ago`;
        
        // For older dates, use readable format
        const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
        return `${months[d.getMonth()]} ${d.getDate()}, ${d.getFullYear()}`;
      }

      function updatePanelSaveMeta(panelKey, ts) {
        document.querySelectorAll(`[data-panel-save="${panelKey}"]`).forEach((el) => {
          el.textContent = ts ? `Last saved ${formatSaveTime(ts)}` : '';
        });
      }

      function recordPanelSave(panelKey) {
        if (!panelKey) return;
        const map = loadPanelSaveTimes();
        const now = new Date().toISOString();
        map[panelKey] = now;
        savePanelSaveTimes(map);
        updatePanelSaveMeta(panelKey, now);
      }

      function recordAllPanelSaves() {
        const map = loadPanelSaveTimes();
        const now = new Date().toISOString();
        document.querySelectorAll('[data-panel-save]').forEach((el) => {
          const key = el.getAttribute('data-panel-save');
          if (key) {
            map[key] = now;
            updatePanelSaveMeta(key, now);
          }
        });
        savePanelSaveTimes(map);
      }

      function panelStatus(panel) {
        const inputs = Array.from(panel.querySelectorAll('input, textarea, select')).filter((el) => {
          if (!el.closest('.panel-content')) return false;
          if (el.type === 'hidden') return false;
          return true;
        });
        const total = inputs.length;
        if (!total) return 'red';
        let filled = 0;
        inputs.forEach((el) => {
          if (el.type === 'file') {
            const field = el.name;
            const existingEl = panel.querySelector(`[data-file-existing="${field}"]`);
            const hasExisting = existingEl && existingEl.style.display !== 'none';
            const hasFile = (el.files && el.files.length) || hasExisting;
            if (hasFile) filled += 1;
            return;
          }
          if (el.type === 'checkbox' || el.type === 'radio') {
            if (el.checked) filled += 1;
            return;
          }
          if ((el.value || '').trim()) filled += 1;
        });
        if (filled === 0) return 'red';
        if (filled === total) return 'green';
        return 'yellow';
      }

      function updatePanelStatuses() {
        document.querySelectorAll('.company-profile-section .profile-panel').forEach((panel) => {
          const status = panelStatus(panel);
          panel.classList.remove('panel-status-green', 'panel-status-yellow', 'panel-status-red');
          panel.classList.add(`panel-status-${status}`);
        });
      }

      function setUsage(textEl, fillEl, used, limit, gradient) {
        if (!textEl || !fillEl) return;
        const unlimited = !limit || limit === Infinity;
        textEl.textContent = unlimited ? `${used} / Unlimited` : `${used} / ${limit}`;
        const pct = unlimited ? 100 : Math.min(100, Math.round((used / limit) * 100));
        fillEl.style.width = `${pct}%`;
        if (gradient) fillEl.style.background = gradient;
      }

      async function savePersonalInfo() {
        const status = document.getElementById('personalInfoStatus');
        const btn = document.getElementById('savePersonalInfo');
        const values = personalFormValues();
        if (status) status.textContent = '';
        if (!values.first_name || !values.last_name) {
          if (status) status.textContent = 'First and last name are required.';
          return;
        }
        btn && (btn.disabled = true);
        try {
          const res = await fetch('/api/account/profile', {
            method: 'POST',
            credentials: 'include',
            headers: {
              'Content-Type': 'application/json',
              'X-CSRF-Token': getCSRF(),
            },
            body: JSON.stringify({
              first_name: values.first_name,
              last_name: values.last_name,
            }),
          });
          if (!res.ok) throw new Error('save failed');
          personalSnapshot = { ...values };
          savePersonalDraft(values);
          if (status) status.textContent = 'Saved.';
        } catch (_) {
          if (status) status.textContent = 'Could not save right now.';
        } finally {
          btn && (btn.disabled = false);
        }
      }

      function resetPersonalInfo() {
        applyPersonalValues(personalSnapshot);
        const status = document.getElementById('personalInfoStatus');
        if (status) status.textContent = '';
      }

      function renderTeam(members, seatLimit) {
        const grid = document.getElementById('teamGrid');
        if (!grid) return;
        const palette = [
          'linear-gradient(135deg, #126a45, #22c55e)',
          'linear-gradient(135deg, #3b82f6, #60a5fa)',
          'linear-gradient(135deg, #8b5cf6, #a78bfa)',
          'linear-gradient(135deg, #f59e0b, #fbbf24)',
        ];
        const cards = members.map((m, idx) => {
          const role = (m.role || 'member').toLowerCase();
          const badgeClass = role === 'owner' ? 'owner' : role === 'admin' ? 'admin' : 'member';
          const bg = palette[idx % palette.length];
          const status = m.accepted ? 'online' : 'offline';
          const statusText = m.accepted ? 'Online now' : 'Pending invite';
          const joined = m.accepted_at ? `Joined ${new Date(m.accepted_at).toLocaleDateString()}` : `Invited ${new Date(m.invited_at || Date.now()).toLocaleDateString()}`;
          const removeBtn = role !== 'owner'
            ? `<button class="team-card-menu" data-remove="${m.id}" data-email="${m.email || ''}">...</button>`
            : '';
          const avatar = m.avatar_url
            ? `<div class="team-card-avatar has-image"><img src="${m.avatar_url}" alt="${m.name || m.email}"></div>`
            : `<div class="team-card-avatar" style="background:${bg};">${initials(m.name || m.email)}</div>`;
          return `
            <div class="team-card ${role === 'owner' ? 'owner-card' : ''}">
              <div class="team-card-header">
                ${avatar}
                <div class="team-card-badge ${badgeClass}">${role.charAt(0).toUpperCase() + role.slice(1)}</div>
              </div>
              <div class="team-card-body">
                <h4>${m.name || m.email}</h4>
                <p>${m.email || ''}</p>
                <span class="team-card-status ${status}">
                  <span class="status-dot"></span>
                  ${statusText}
                </span>
              </div>
              <div class="team-card-footer">
                <span class="team-card-joined">${joined}</span>
                ${removeBtn}
              </div>
            </div>
          `;
        });
        const remaining = Math.max(0, (seatLimit || members.length) - members.length);
        cards.push(`
          <div class="team-card add-card" id="teamAddCard">
            <div class="add-card-content">
              <div class="add-card-icon">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <line x1="12" y1="5" x2="12" y2="19"></line>
                  <line x1="5" y1="12" x2="19" y2="12"></line>
                </svg>
              </div>
              <h4>Add Team Member</h4>
              <p>${remaining} seats remaining</p>
            </div>
          </div>
        `);
        grid.innerHTML = cards.join('');
      }

      function renderTeamPreview(members){
        const wrap = document.getElementById('teamListCard');
        if (!wrap) return;
        if (!members || !members.length) {
          wrap.innerHTML = "<div class='muted'>No teammates yet.</div>";
          return;
        }
        const palette = [
          'linear-gradient(135deg, #126a45, #22c55e)',
          'linear-gradient(135deg, #3b82f6, #60a5fa)',
          'linear-gradient(135deg, #8b5cf6, #a78bfa)',
          'linear-gradient(135deg, #f59e0b, #fbbf24)',
        ];
        wrap.innerHTML = members.map((m, idx) => {
          const role = (m.role || 'member').toLowerCase();
          const bg = palette[idx % palette.length];
          const avatar = m.avatar_url
            ? `<div class="member-avatar has-image"><img src="${m.avatar_url}" alt="${m.name || m.email}"></div>`
            : `<div class="member-avatar" style="background:${bg};">${initials(m.name || m.email)}</div>`;
          return `
            <div class="team-member">
              ${avatar}
              <div class="member-info">
                <span class="member-name">${m.name || m.email}</span>
                <span class="member-role">${role.charAt(0).toUpperCase() + role.slice(1)}</span>
              </div>
            </div>
          `;
        }).join('');
      }

      function formatActivityTime(iso) {
        if (!iso) return '';
        const d = new Date(iso);
        if (isNaN(d.getTime())) return '';
        return d.toLocaleString('en-US', { month: 'short', day: 'numeric' });
      }

      function renderActivity(entries) {
        const list = document.getElementById('activityList');
        if (!list) return;
        if (!entries || !entries.length) {
          list.innerHTML = "<div class='muted'>No recent activity yet.</div>";
          return;
        }
        const iconFor = (type) => {
          if (type === 'upload') return 'blue';
          return 'green';
        };
        list.innerHTML = entries.slice(0, 5).map((a) => {
          const color = iconFor(a.type);
          const who = a.who || '';
          const verb = a.verb || '';
          const obj = a.obj || '';
          const when = formatActivityTime(a.when);
          return `
            <div class="activity-item">
              <div class="activity-icon ${color}">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <polyline points="20 6 9 17 4 12"></polyline>
                </svg>
              </div>
              <div class="activity-content">
                <span class="activity-text">${who ? `<strong>${who}</strong> ` : ''}${verb} ${obj ? `<strong>${obj}</strong>` : ''}</span>
                <span class="activity-time">${when}</span>
              </div>
            </div>
          `;
        }).join('');
      }

      function renderPendingInvites(members) {
        const wrap = document.getElementById('pendingInvites');
        if (!wrap) return;
        const pending = (members || []).filter(m => !m.accepted);
        if (!pending.length) {
          wrap.innerHTML = "<div class='muted'>No pending invites.</div>";
          return;
        }
        wrap.innerHTML = pending
          .map((m) => {
            const sentLabel = m.invited_at
              ? `Sent ${new Date(m.invited_at).toLocaleDateString()}`
              : 'Sent';
            return `
              <div class="pending-invite" data-invite-id="${m.id}" data-email="${m.email || m.invited_email || ''}">
                <div class="pending-avatar">${initials(m.name || m.email || m.invited_email)}</div>
                <div class="pending-info">
                  <span class="pending-email">${m.email || m.invited_email || ''}</span>
                  <span class="pending-sent">${sentLabel}</span>
                </div>
                <div class="pending-actions">
                  <button class="btn-ghost" data-resend="${m.email || m.invited_email || ''}">Resend</button>
                  <button class="btn-danger-ghost" data-revoke="${m.id}">Revoke</button>
                </div>
              </div>
            `;
          })
          .join('');
      }

      function bindTeamHandlers() {
        const grid = document.getElementById('teamGrid');
        if (!grid) return;
        grid.addEventListener('click', async (e) => {
          if (e.target.closest('#teamAddCard')) {
            inviteFlow();
            return;
          }
          const removeBtn = e.target.closest('[data-remove]');
          if (removeBtn) {
            const id = removeBtn.getAttribute('data-remove');
            const email = removeBtn.getAttribute('data-email') || 'this member';
            if (!id) return;
            if (!confirm(`Remove ${email} from your team?`)) return;
            removeBtn.disabled = true;
            try {
              const res = await fetch(`/api/team/members/${id}/remove`, {
                method: 'POST',
                credentials: 'include',
                headers: { 'X-CSRF-Token': getCSRF() },
              });
              if (!res.ok) throw new Error('Failed');
              await loadAccount();
            } catch (_) {
              alert('Could not remove member (owner required).');
            } finally {
              removeBtn.disabled = false;
            }
          }
        });

        const pendingWrap = document.getElementById('pendingInvites');
        if (pendingWrap) {
          pendingWrap.addEventListener('click', async (e) => {
            const resend = e.target.closest('[data-resend]');
            if (resend) {
              const email = resend.getAttribute('data-resend');
              if (!email) return;
              resend.disabled = true;
              try {
                const res = await fetch('/api/team/invite', {
                  method: 'POST',
                  credentials: 'include',
                  headers: { 'Content-Type': 'application/json', 'X-CSRF-Token': getCSRF() },
                  body: JSON.stringify({ email }),
                });
                if (!res.ok) throw new Error('failed');
                alert('Invitation resent.');
                await loadAccount();
              } catch (_) {
                alert('Could not resend invite.');
              } finally {
                resend.disabled = false;
              }
              return;
            }
            const revoke = e.target.closest('[data-revoke]');
            if (revoke) {
              const id = revoke.getAttribute('data-revoke');
              const email = revoke.closest('.pending-invite')?.getAttribute('data-email') || 'this invite';
              if (!id) return;
              if (!confirm(`Revoke invite for ${email}?`)) return;
              revoke.disabled = true;
              try {
                const res = await fetch(`/api/team/members/${id}/remove`, {
                  method: 'POST',
                  credentials: 'include',
                  headers: { 'X-CSRF-Token': getCSRF() },
                });
                if (!res.ok) throw new Error('failed');
                await loadAccount();
              } catch (_) {
                alert('Could not revoke invite (owner required).');
              } finally {
                revoke.disabled = false;
              }
            }
          });
        }
      }

      const inviteFlow = () => {
        showTab('team', { updateHash: true });
        openInviteModal();
      };

      async function loadAccount() {
        const res = await fetch('/api/account/overview', { credentials: 'include' });
        if (!res.ok) {
          console.error('Failed to load account overview', res.status);
          return;
        }
        const data = await res.json();
        const user = data.user || {};
        const plan = data.plan || {};
        const usage = data.usage || {};
        const team = data.team || {};
        const name = user.name || user.email || 'My Account';
        const nameEl = document.getElementById('accountName');
        if (nameEl) nameEl.textContent = name;
        const emailEl = document.getElementById('accountEmail');
        if (emailEl) emailEl.textContent = user.email || '';
        const pf = document.getElementById('profileFirstName');
        if (pf) pf.value = user.first_name || '';
        const pl = document.getElementById('profileLastName');
        if (pl) pl.value = user.last_name || '';
        const pe = document.getElementById('profileEmail');
        if (pe) pe.value = user.email || '';
        personalSnapshot = {
          first_name: user.first_name || '',
          last_name: user.last_name || '',
          email: user.email || '',
          phone: document.getElementById('profilePhone')?.value || '',
          title: document.getElementById('profileJobTitle')?.value || '',
        };
        loadPersonalDraft(true);
        const avatar = document.getElementById('avatarInitials');
        if (avatar && avatar.querySelector('span')) avatar.querySelector('span').textContent = initials(name);
        const topAvatar = document.getElementById('topAvatar');
        if (topAvatar) topAvatar.textContent = initials(name);
        // Load avatar if exists
        if (user.avatar_url) {
          const largeAvatar = document.getElementById('avatarInitials');
          largeAvatar.classList.add('has-image');
          let img = largeAvatar.querySelector('img');
          if (!img) {
            img = document.createElement('img');
            largeAvatar.insertBefore(img, largeAvatar.firstChild);
          }
          img.src = user.avatar_url;
          
          const topAvatar = document.getElementById('topAvatar');
          if (topAvatar) {
            topAvatar.innerHTML = `<img src="${user.avatar_url}" style="width:100%;height:100%;object-fit:cover;border-radius:50%;">`;
          }
        }
        const badge = document.getElementById('planBadge');
        const badgeLabel = document.getElementById('planBadgeLabel');
        if (badge) badge.style.display = plan.label ? 'inline-flex' : 'none';
        if (badgeLabel) badgeLabel.textContent = plan.label || '';
        if (badge && !badgeLabel) badge.textContent = plan.label || '';
        const teamBadge = document.getElementById('teamBadge');
        const teamBadgeLabel = document.getElementById('teamBadgeLabel');
        if (teamBadge) {
          const isTeam = !!(data.team && data.team.team_id);
          const roleLabel = (user.role || '').toLowerCase();
          if (isTeam) {
            teamBadge.style.display = 'inline-flex';
            if (teamBadgeLabel) teamBadgeLabel.textContent = roleLabel === 'owner' ? 'Team Owner' : 'Team Member';
          } else {
            teamBadge.style.display = 'none';
          }
        }
        const verifiedBadge = document.getElementById('verifiedBadge');
        if (verifiedBadge) {
          verifiedBadge.style.display = user.email_verified ? 'inline-flex' : 'none';
        }
        const memberSinceEl = document.getElementById('memberSince');
        if (memberSinceEl) {
          const niceDate = formatMonthYear(user.created_at);
          memberSinceEl.textContent = niceDate ? `Member since ${niceDate}` : 'Member';
        }
        const usagePeriodEl = document.querySelector('.usage-card .card-period');
        if (usagePeriodEl) {
          const now = new Date();
          const end = new Date(now.getFullYear(), now.getMonth() + 1, 0).getDate();
          const month = now.toLocaleString('en-US', { month: 'short' });
          usagePeriodEl.textContent = `${month} 1 - ${month} ${end}`;
        }
        const planNameEl = document.getElementById('planName');
        if (planNameEl) planNameEl.textContent = plan.label || '';
        const planPriceEl = document.getElementById('planPrice');
        if (planPriceEl) planPriceEl.textContent = plan.amount || '$0';
        const planPeriodEl = document.getElementById('planPeriod');
        if (planPeriodEl) planPeriodEl.textContent = plan.period || '/month';
        const topTierLabel = document.getElementById('topTierLabel');
        if (topTierLabel) topTierLabel.textContent = plan.label || '';
        const planNextBillingEl = document.getElementById('planNextBilling');
        if (planNextBillingEl) {
          const raw = plan.next_billing || plan.next_billing_at || plan.next_invoice_at;
          if (raw) {
            const d = new Date(raw);
            planNextBillingEl.textContent = isNaN(d.getTime()) ? raw : d.toLocaleDateString(undefined, { month: 'long', day: 'numeric', year: 'numeric' });
          } else {
            planNextBillingEl.textContent = '--';
          }
        }
        const tierKey = (user.tier_key || '').toLowerCase();
        const seatLimit = (planPricing[tierKey] || {}).limit || usage.team || 5;
        setUsage(document.getElementById('usageBids'), document.getElementById('usageBidsFill'), usage.tracked || 0, Infinity, 'var(--primary-gradient)');
        setUsage(document.getElementById('usageTeam'), document.getElementById('usageTeamFill'), usage.team || 0, seatLimit);
        const docsMB = (usage.documents?.bytes || 0) / (1024 * 1024);
      setUsage(document.getElementById('usageDocs'), document.getElementById('usageDocsFill'), Math.round(docsMB), 5000);
      setUsage(document.getElementById('usageTokens'), document.getElementById('usageTokensFill'), usage.token_calls || 0, 10000);

        const teamMembers = team.members || [];
        const teamCountEl = document.getElementById('teamCount');
        const teamAvailEl = document.getElementById('teamAvailable');
        if (teamCountEl) teamCountEl.textContent = teamMembers.length.toString();
        if (teamAvailEl) teamAvailEl.textContent = Math.max(0, seatLimit - teamMembers.length).toString();
        renderTeam(teamMembers, seatLimit);
        renderTeamPreview(teamMembers);
        renderPendingInvites(teamMembers);
        renderActivity(data.activity || []);
      }

      function calculateProfileProgress() {
        const requiredFields = [
          'legal_name', 'ein', 'business_type', 'state_incorp', 'year_founded',
          'hq_address', 'city', 'state', 'zip',
          'primary_name', 'primary_email', 'primary_phone',
          'years_experience', 'experience',
          'gl_coverage', 'wc_coverage',
          'signer_name', 'signer_title'
        ];

        const form = document.getElementById('companyProfileForm');
        if (!form) return 0;

        let filled = 0;
        requiredFields.forEach((name) => {
          const el = form.querySelector(`[name="${name}"]`);
          if (el && el.value && el.value.trim()) filled += 1;
        });

        const ref1Business = form.querySelector('[name="ref1_business"]');
        if (ref1Business && ref1Business.value.trim()) filled += 1;

        const total = requiredFields.length + 1;
        const percent = Math.round((filled / total) * 100);

        const valueEl = document.getElementById('profileCompleteness');
        const fillEl = document.getElementById('profileProgressFill');
        const hintEl = document.getElementById('profileProgressHint');

        if (valueEl) valueEl.textContent = `${percent}%`;
        if (fillEl) fillEl.style.width = `${percent}%`;
        if (hintEl) {
          if (percent < 30) hintEl.textContent = 'Add basic company info to get started';
          else if (percent < 60) hintEl.textContent = 'Add contacts and experience details';
          else if (percent < 90) hintEl.textContent = 'Almost there! Add insurance and references';
          else hintEl.textContent = '✓ Great! Your profile covers most RFP requirements';
        }

        return percent;
      }

      function setMainFieldValue(name, value) {
        const field = document.querySelector(`#companyProfileForm [name="${name}"]`);
        if (!field) return;
        if (field.type === 'checkbox') {
          field.checked = value === true || value === 'true' || value === 'on';
        } else {
          field.value = value ?? '';
        }
        field.dispatchEvent(new Event('input', { bubbles: true }));
        field.dispatchEvent(new Event('change', { bubbles: true }));
      }

      function getMainFieldValue(name) {
        const field = document.querySelector(`#companyProfileForm [name="${name}"]`);
        if (!field) return '';
        if (field.type === 'checkbox') return field.checked;
        return field.value || '';
      }

      function initSubAccordions() {
        document.querySelectorAll('.sub-accordion-header').forEach((btn) => {
          btn.addEventListener('click', () => {
            const item = btn.closest('.sub-accordion-item');
            if (!item) return;
            const isOpen = item.classList.contains('open');
            item.classList.toggle('open');
            btn.setAttribute('aria-expanded', (!isOpen).toString());
          });
        });
      }

      function initQuickSetupWizard() {
        const modal = document.getElementById('quickSetupModal');
        const startBtn = document.getElementById('startQuickSetup');
        const skipBtn = document.getElementById('skipQuickSetup');
        const closeBtn = document.getElementById('quickSetupClose');
        const backBtn = document.getElementById('quickBackBtn');
        const nextBtn = document.getElementById('quickNextBtn');
        const steps = Array.from(document.querySelectorAll('.quick-step'));
        const stepLabel = document.getElementById('quickStepLabel');
        const quickCard = document.getElementById('quickSetupCard');
        const dismissedKey = 'quickSetupDismissed';
        let stepIndex = 0;

        if (!steps.length) return;

        const total = steps.length;

        const syncFromMain = (stepEl) => {
          stepEl.querySelectorAll('[data-field]').forEach((input) => {
            const name = input.dataset.field;
            const val = getMainFieldValue(name);
            if (input.type === 'checkbox') {
              input.checked = val === true || val === 'true' || val === 'on';
            } else {
              input.value = val || '';
            }
          });
        };

        const persistStep = (stepEl) => {
          stepEl.querySelectorAll('[data-field]').forEach((input) => {
            const name = input.dataset.field;
            const val = input.type === 'checkbox' ? input.checked : input.value;
            setMainFieldValue(name, val);
          });
          updatePanelStatuses();
          calculateProfileProgress();
          return true;
        };

        const showStep = (idx) => {
          steps.forEach((el, i) => el.classList.toggle('active', i === idx));
          if (stepLabel) stepLabel.textContent = `Step ${idx + 1} of ${total}`;
          if (backBtn) backBtn.style.visibility = idx === 0 ? 'hidden' : 'visible';
          if (nextBtn) nextBtn.textContent = idx === total - 1 ? 'Finish' : 'Next';
          syncFromMain(steps[idx]);
        };

        const openWizard = () => {
          if (!modal) return;
          modal.style.display = 'flex';
          stepIndex = 0;
          showStep(stepIndex);
        };

        const closeWizard = () => {
          if (!modal) return;
          modal.style.display = 'none';
          localStorage.setItem(dismissedKey, '1');
        };

        startBtn?.addEventListener('click', () => {
          openWizard();
        });

        skipBtn?.addEventListener('click', () => {
          localStorage.setItem(dismissedKey, '1');
          if (quickCard) quickCard.style.display = 'none';
        });

        closeBtn?.addEventListener('click', closeWizard);

        nextBtn?.addEventListener('click', () => {
          if (!persistStep(steps[stepIndex])) return;
          if (stepIndex < total - 1) {
            stepIndex += 1;
            showStep(stepIndex);
          } else {
            closeWizard();
          }
        });

        backBtn?.addEventListener('click', () => {
          if (!persistStep(steps[stepIndex])) return;
          if (stepIndex > 0) {
            stepIndex -= 1;
            showStep(stepIndex);
          }
        });

        if (modal) {
          modal.addEventListener('click', (e) => {
            if (e.target === modal) closeWizard();
          });
        }

        if (localStorage.getItem(dismissedKey)) {
          if (quickCard) quickCard.style.display = 'none';
        }
      }

      async function loadCompanyProfile() {
        try {
          const status = document.getElementById('companyProfileStatus');
          if (status) status.textContent = '';
          const res = await fetch('/api/company-profile', { credentials: 'include' });
          if (!res.ok) return;
          const resp = await res.json();
          const payload = resp.data || {};
          const files = resp.files || {};
          // DEBUG: Log what files the API returns
          console.log('[loadCompanyProfile] files from API:', files);
          console.log('[loadCompanyProfile] payload keys:', Object.keys(payload));
          const form = document.getElementById('companyProfileForm');
          if (!form) return;
          Array.from(form.querySelectorAll('[name]')).forEach((el) => {
            const key = el.getAttribute('name');
            if (!key) return;
            if (el.type === 'checkbox') {
              if (el.dataset.multi === 'true') {
                const values = (payload[key] || '').split(',').map((v) => v.trim());
                el.checked = values.includes(el.value);
              } else {
                el.checked = !!payload[key];
              }
            } else if (el.type === 'radio') {
              el.checked = payload[key] === el.value;
            } else if (el.multiple && el.tagName === 'SELECT') {
              const values = (payload[key] || '').split(',').map((v) => v.trim()).filter(Boolean);
              Array.from(el.options).forEach((opt) => { opt.selected = values.includes(opt.value); });
            } else {
              el.value = payload[key] || '';
            }
          });

          // show file links
          Object.entries(files).forEach(([field, meta]) => {
            showExistingFile(field, meta?.name || meta?.key || '', meta?.url);
          });
          // Also reflect stored filenames even if no URL available
          Object.keys(payload || {}).forEach((key) => {
            if (!key.endsWith('_name')) return;
            const field = key.replace(/_name$/, '');
            const existingName = payload[key];
            if (existingName) {
              const meta = files[field] || {};
              showExistingFile(field, existingName, meta.url);
            }
          });
          // Fallback: if we have a stored key but no name, still show something
          Object.keys(payload || {}).forEach((key) => {
            if (key.endsWith('_name')) return;
            if (!fileFields.includes(key)) return;
            const meta = files[key] || {};
            const displayName = meta.name || payload[`${key}_name`] || payload[key] || 'Uploaded file';
            showExistingFile(key, displayName, meta.url);
          });
          fileFields.forEach((field) => {
            const meta = files?.[field] || {};
            setFileExtractionStatus(field, meta, payload);
            const warningFlag = meta.scanned_warning ?? payload?.[`${field}_scanned_warning`];
            const storageKey = meta.key || payload?.[field];
            const hasStorage = Boolean(storageKey)
              && typeof storageKey === 'string'
              && !storageKey.includes('UploadFile(')
              && !storageKey.includes('Headers(');
            if (warningFlag && hasStorage) {
              setFileWarning(field, 'Scanned PDF detected. AI may not read this file.');
            } else {
              setFileWarning(field, '');
            }
          });
          updatePanelStatuses();
          calculateProfileProgress();
        } catch (_) { /* noop */ }
      }

      function collectCompanyProfile() {
        const form = document.getElementById('companyProfileForm');
        if (!form) return new FormData();
        const data = new FormData();
        const multi = {};
        const debugFiles = [];
        const fileInputs = Array.from(form.querySelectorAll('input[type="file"][name]'));
        const fileWithSelection = fileInputs.filter((input) => input.files && input.files.length);
        console.log(`[CompanyProfile] File inputs: ${fileInputs.length}, with selection: ${fileWithSelection.length}`);
        Array.from(form.querySelectorAll('[name]')).forEach((el) => {
          const key = el.getAttribute('name');
          if (!key) return;
          if (el.dataset.multi === 'true') {
            if (!multi[key]) multi[key] = [];
            if (el.checked) multi[key].push(el.value);
            return;
          }
          if (el.type === 'radio') {
            if (el.checked) data.append(key, el.value || '');
            return;
          }
          if (el.type === 'checkbox') {
            data.append(key, el.checked ? 'true' : 'false');
          } else if (el.type === 'file') {
            if (el.files && el.files.length) {
              Array.from(el.files).forEach((file) => data.append(key, file));
              Array.from(el.files).forEach((file) => {
                debugFiles.push({
                  field: key,
                  name: file.name,
                  size: file.size,
                  type: file.type || '',
                });
              });
            }
          } else if (el.multiple && el.tagName === 'SELECT') {
            const selected = Array.from(el.selectedOptions).map((o) => o.value).filter(Boolean);
            data.append(key, selected.join(','));
          } else {
            data.append(key, el.value || '');
          }
        });
        Object.entries(multi).forEach(([key, values]) => {
          data.append(key, values.join(','));
        });
        if (debugFiles.length) {
          console.log('[CompanyProfile] Collected file uploads:', debugFiles);
        } else {
          console.warn('[CompanyProfile] No files collected in payload');
        }
        return data;
      }

      async function saveCompanyProfile(panelKey) {
        const mainBtn = document.getElementById('saveCompanyProfile');
        const status = document.getElementById('companyProfileStatus');
        
        // Find the section button if panelKey provided
        let sectionBtn = null;
        let sectionMeta = null;
        if (panelKey) {
          sectionBtn = document.querySelector(`[data-panel-key="${panelKey}"]`);
          sectionMeta = document.querySelector(`[data-panel-save="${panelKey}"]`);
        }
        
        // Disable buttons and show loading state
        if (status) status.textContent = '';
        if (mainBtn) mainBtn.disabled = true;
        if (sectionBtn) {
          sectionBtn.disabled = true;
          sectionBtn.textContent = 'Saving...';
        }
        
        try {
          const payload = collectCompanyProfile();
          const res = await fetch('/api/company-profile', {
            method: 'POST',
            credentials: 'include',
            headers: { 'X-CSRF-Token': getCSRF() },
            body: payload,
          });
          if (!res.ok) throw new Error('Save failed');
          
          // Show success
          if (status) status.textContent = 'Company profile saved.';
          if (sectionMeta) sectionMeta.textContent = 'Saved just now';
          
          if (panelKey) {
            recordPanelSave(panelKey);
          } else {
            recordAllPanelSaves();
          }
          
          // Reload profile to reflect uploaded files
          await loadCompanyProfile();
          
        } catch (_) {
          if (status) status.textContent = 'Could not save company profile.';
          if (sectionMeta) sectionMeta.textContent = 'Save failed';
        } finally {
          if (mainBtn) mainBtn.disabled = false;
          if (sectionBtn) {
            sectionBtn.disabled = false;
            sectionBtn.textContent = 'Save this section';
          }
        }
      }

      document.getElementById('saveCompanyProfile')?.addEventListener('click', () => saveCompanyProfile());
      document.getElementById('resetCompanyProfile')?.addEventListener('click', loadCompanyProfile);

      function bindFilePreviews() {
        document.querySelectorAll('.company-profile-section input[type="file"]').forEach((input) => {
          if (input.dataset.boundChange === '1') return;
          input.dataset.boundChange = '1';
          input.addEventListener('change', () => {
            const file = input.files?.[0];
            if (file) {
              markFileSelection(input, file.name);
            }
          });
        });
      }

      function addPanelSaveButtons() {
        document.querySelectorAll('.company-profile-section .profile-panel').forEach((panel, idx) => {
          if (panel.querySelector('.panel-save-actions')) return;
          const content = panel.querySelector('.panel-content');
          if (!content) return;
          const wrapper = document.createElement('div');
          wrapper.className = 'panel-save-actions';
          const btn = document.createElement('button');
          btn.type = 'button';
          btn.className = 'btn-primary';
          btn.textContent = 'Save this section';
          const key = (panel.querySelector('.panel-title h3')?.textContent || `panel-${idx + 1}`)
            .toLowerCase()
            .replace(/\s+/g, '-')
            .replace(/[^a-z0-9\-]/g, '');
          btn.dataset.panelKey = key;
          const meta = document.createElement('span');
          meta.className = 'panel-save-meta';
          meta.setAttribute('data-panel-save', key);
          const savedMap = loadPanelSaveTimes();
          if (savedMap[key]) {
            meta.textContent = `Last saved ${formatSaveTime(savedMap[key])}`;
          }
          btn.addEventListener('click', () => saveCompanyProfile(key));
          wrapper.appendChild(btn);
          wrapper.appendChild(meta);
          content.appendChild(wrapper);
        });
        updatePanelStatuses();
      }

      // Dynamic repeatables for references and subcontractors
      let referenceCount = document.querySelectorAll('#referencesContainer .reference-entry').length || 1;
      let subCount = document.querySelectorAll('#subcontractorList .subcontractor-entry').length || 1;

      function addReference() {
        const container = document.getElementById('referencesContainer');
        if (!container) return;
        const current = container.querySelectorAll('.reference-entry').length;
        if (current >= 5) {
          alert('Maximum of 5 references.');
          return;
        }
        const n = current + 1;
        referenceCount = n;
        const entry = document.createElement('div');
        entry.className = 'reference-entry';
        entry.dataset.index = n;
        entry.innerHTML = `
          <div class="reference-header">
            <h4>Reference #${n}</h4>
            <button type="button" class="remove-btn" onclick="removeReference(this)">Remove</button>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>Business Name <span class="required">*</span></label>
              <input type="text" name="ref${n}_business" class="form-input" placeholder="Client company name">
            </div>
            <div class="form-group">
              <label>Contact Name <span class="required">*</span></label>
              <input type="text" name="ref${n}_contact" class="form-input" placeholder="Contact person">
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>Title</label>
              <input type="text" name="ref${n}_title" class="form-input" placeholder="Job title">
            </div>
            <div class="form-group">
              <label>Email <span class="required">*</span></label>
              <input type="email" name="ref${n}_email" class="form-input" placeholder="contact@company.com">
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>Phone <span class="required">*</span></label>
              <input type="tel" name="ref${n}_phone" class="form-input" placeholder="(xxx) xxx-xxxx">
            </div>
            <div class="form-group">
              <label>Address</label>
              <input type="text" name="ref${n}_address" class="form-input" placeholder="City, State">
            </div>
          </div>
          <div class="form-group">
            <label>Project / Contract Description <span class="required">*</span></label>
            <textarea class="form-textarea" name="ref${n}_description" rows="2" placeholder="Brief description of work performed..."></textarea>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>Contract Amount</label>
              <input type="text" name="ref${n}_amount" class="form-input" placeholder="$XXX,XXX (optional)">
            </div>
            <div class="form-group">
              <label>Contract Dates</label>
              <input type="text" name="ref${n}_dates" class="form-input" placeholder="MM/YYYY - MM/YYYY">
            </div>
          </div>
          <div class="form-group">
            <label>Reference Letter</label>
            <div class="file-upload-area small">
              <input type="file" name="ref${n}_letter" id="ref${n}_letter" accept=".pdf,.jpg,.png,.docx" hidden>
              <label class="file-upload-label small" for="ref${n}_letter">
                <span class="upload-text">Upload letter (optional)</span>
              </label>
            </div>
          </div>
        `;
        const removeBtn = entry.querySelector('.remove-btn');
        if (n === 1 && removeBtn) {
          removeBtn.style.display = 'none';
        }
        entry.querySelectorAll('input, textarea, select').forEach((el) => {
          el.addEventListener('input', updatePanelStatuses);
          el.addEventListener('change', updatePanelStatuses);
        });
        container.appendChild(entry);
        upgradeFileInputs();
        bindFilePreviews();
        bindFileReplaceButtons();
        updatePanelStatuses();
      }

      function removeReference(btn) {
        const entry = btn.closest('.reference-entry');
        const container = document.getElementById('referencesContainer');
        if (!entry || !container) return;
        entry.remove();
        const remaining = container.querySelectorAll('.reference-entry').length;
        if (remaining === 0) {
          referenceCount = 0;
          addReference();
        } else {
          updatePanelStatuses();
        }
      }

      function removeSubcontractor(btn) {
        const entry = btn.closest('.subcontractor-entry');
        const container = document.getElementById('subcontractorList');
        if (!entry || !container) return;
        entry.remove();
        const remaining = container.querySelectorAll('.subcontractor-entry').length;
        if (remaining === 0) {
          subCount = 0;
          addSubcontractor();
        } else {
          updatePanelStatuses();
        }
      }

      function addSubcontractor() {
        const container = document.getElementById('subcontractorList');
        if (!container) return;
        const current = container.querySelectorAll('.subcontractor-entry').length;
        const n = current + 1;
        subCount = n;
        const card = createSubcontractorCard(n);
        container.appendChild(card);
        upgradeFileInputs();
        bindFilePreviews();
        bindFileReplaceButtons();
        updatePanelStatuses();
      }

      // expose reference handlers for inline buttons
      window.addReference = addReference;
      window.removeReference = removeReference;
      window.removeSubcontractor = removeSubcontractor;
      window.addSubcontractor = addSubcontractor;

            function createSubcontractorCard(n) {
        const wrapper = document.createElement('div');
        wrapper.className = 'repeatable-card subcontractor-entry';
        wrapper.dataset.index = n;
        wrapper.innerHTML = `
          <div class="subcontractor-header reference-header">
            <h4>Subcontractor #${n}</h4>
            <button type="button" class="remove-btn" onclick="removeSubcontractor(this)">Remove</button>
          </div>
          <div class="form-row three-col">
            <div class="form-group">
              <label>Subcontractor Business Name</label>
              <input type="text" name="sub${n}_name" class="form-input">
            </div>
            <div class="form-group">
              <label>Contact Person</label>
              <input type="text" name="sub${n}_contact" class="form-input">
            </div>
            <div class="form-group">
              <label>Email</label>
              <input type="email" name="sub${n}_email" class="form-input">
            </div>
          </div>
          <div class="form-row three-col">
            <div class="form-group">
              <label>Phone</label>
              <input type="tel" name="sub${n}_phone" class="form-input">
            </div>
            <div class="form-group">
              <label>Address</label>
              <input type="text" name="sub${n}_address" class="form-input">
            </div>
            <div class="form-group">
              <label>Work Performed / Scope</label>
              <input type="text" name="sub${n}_scope" class="form-input">
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>Contract Compliance Certification Number (if applicable)</label>
              <input type="text" name="sub${n}_compliance" class="form-input">
            </div>
            <div class="form-group">
              <label>Upload - Subcontractor Compliance Certificate (optional)</label>
              <div class="file-upload-area">
                <input type="file" name="sub${n}_certificate" id="upload-sub${n}_certificate" class="form-input file-input" accept=".pdf,.jpg,.jpeg,.png,.doc,.docx" hidden>
                <label for="upload-sub${n}_certificate" class="file-upload-label">
                  <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                    <polyline points="17 8 12 3 7 8"/>
                    <line x1="12" y1="3" x2="12" y2="15"/>
                  </svg>
                  <span class="upload-text">Upload compliance certificate</span>
                  <span class="upload-hint">PDF, JPG, PNG, DOCX (max 25MB)</span>
                </label>
              </div>
            </div>
          </div>
        `;
        if (n === 1) {
          const removeBtn = wrapper.querySelector('.remove-btn');
          if (removeBtn) removeBtn.style.display = 'none';
        }
        wrapper.querySelectorAll('input, textarea, select').forEach((el) => {
          el.addEventListener('input', updatePanelStatuses);
          el.addEventListener('change', updatePanelStatuses);
        });
        return wrapper;
      }
(function bindRepeatables() {
        document.getElementById('addReferenceBtn')?.addEventListener('click', addReference);

        document.getElementById('addSubcontractorBtn')?.addEventListener('click', addSubcontractor);
      })();

      // Bind actions
      document.getElementById('qaEditProfile')?.addEventListener('click', () => {
        document.querySelector('[data-tab=\"profile\"]')?.click();
      });
      document.getElementById('qaInviteMember')?.addEventListener('click', inviteFlow);
      document.getElementById('qaUpdatePayment')?.addEventListener('click', async () => {
        try {
          const res = await fetch('/billing/portal', { credentials: 'include' });
          if (!res.ok) throw new Error();
          const data = await res.json();
          if (data?.url) {
            window.open(data.url, '_blank', 'noopener');
          } else {
            alert('Could not open Stripe portal right now.');
          }
        } catch (_) {
          alert('Could not open Stripe portal right now.');
        }
      });
      document.getElementById('qaExportData')?.addEventListener('click', () => window.location.href = '/billing');
      document.getElementById('teamInviteBtn')?.addEventListener('click', inviteFlow);
      document.getElementById('teamInviteCardBtn')?.addEventListener('click', inviteFlow);

      // Billing summary (Stripe) in /account Billing tab
      let billingLoaded = false;
      const formatMoney = (amount, currency) => {
        if (amount == null) return '';
        const amt = (Number(amount) || 0) / 100;
        try {
          return new Intl.NumberFormat('en-US', {
            style: 'currency',
            currency: (currency || 'USD').toUpperCase(),
            minimumFractionDigits: 2,
          }).format(amt);
        } catch (_) {
          return `$${amt.toFixed(2)}`;
        }
      };
      const formatDate = (val) => {
        if (!val) return '';
        try {
          const dt = typeof val === 'number' ? new Date(val * 1000) : new Date(val);
          return dt.toLocaleDateString(undefined, { month: 'short', day: 'numeric', year: 'numeric' });
        } catch (_) {
          return String(val);
        }
      };
      const renderBillingPlan = (data) => {
        const tier = (data?.tier || '').trim() || 'Professional';
        const invoices = data?.invoices || [];
        const latest = invoices[0] || null;
        const price = latest ? formatMoney(latest.amount_paid ?? latest.amount_due, latest.currency) : '$--';
        const cycle = 'Monthly';
        const annualCost = latest ? formatMoney(((latest.amount_paid ?? latest.amount_due) || 0) * 12, latest.currency) : '$--';
        const nextBilling = data?.next_billing_at ? formatDate(data.next_billing_at) : '--';
        const map = {
          starter: 'Starter',
          professional: 'Professional',
          enterprise: 'Enterprise',
        };
        const friendlyTier = map[tier.toLowerCase()] || tier;
        const planNameEl = document.getElementById('billingPlanName');
        const priceEl = document.getElementById('billingPlanPrice');
        const periodEl = document.getElementById('billingPlanPeriod');
        const annualEl = document.getElementById('billingAnnualCost');
        const nextEl = document.getElementById('billingNextBilling');
        const cycleEl = document.getElementById('billingCycle');
        const topTier = document.getElementById('topTierLabel');
        const planBadgeWrap = document.getElementById('planBadge');
        const planBadge = document.getElementById('planBadgeLabel');
        const planName = document.getElementById('planName');
        const planPrice = document.getElementById('planPrice');
        const planPeriod = document.getElementById('planPeriod');
        if (planNameEl) planNameEl.textContent = friendlyTier;
        if (priceEl) priceEl.textContent = price;
        if (periodEl) periodEl.textContent = '/month';
        if (annualEl) annualEl.textContent = annualCost;
        if (nextEl) nextEl.textContent = nextBilling;
        if (cycleEl) cycleEl.textContent = cycle;
        if (topTier) topTier.textContent = friendlyTier;
        if (planBadgeWrap) planBadgeWrap.style.display = friendlyTier ? 'inline-flex' : 'none';
        if (planBadge) planBadge.textContent = friendlyTier;
        if (planName) planName.textContent = friendlyTier;
        if (planPrice) planPrice.textContent = price;
        if (planPeriod) planPeriod.textContent = '/month';
      };
      const openBillingPortal = async () => {
        try {
          const res = await fetch('/billing/portal', { credentials: 'include' });
          if (!res.ok) throw new Error();
          const data = await res.json();
          if (data?.url) window.open(data.url, '_blank', 'noopener');
        } catch (_) {
          alert('Could not open subscription management right now.');
        }
      };
      const renderPaymentMethod = (pmInfo) => {
        const container = document.getElementById('billingPaymentMethods');
        if (!container) return;
        if (!pmInfo || (!pmInfo.brand && !pmInfo.last4)) {
          container.innerHTML = '<div class="muted">No payment method on file.</div>';
          return;
        }
        const { brand, last4, exp_month, exp_year } = pmInfo;
        const exp = exp_month && exp_year ? `Expires ${String(exp_month).padStart(2, '0')}/${String(exp_year).slice(-2)}` : '';
        container.innerHTML = `
          <div class="payment-card active">
            <div class="payment-card-icon">
              <svg width="32" height="32" viewBox="0 0 24 24" fill="none">
                <rect x="1" y="4" width="22" height="16" rx="3" fill="#1A1F71"></rect>
                <text x="12" y="14" text-anchor="middle" fill="white" font-size="6" font-weight="bold">${(brand || 'CARD').toUpperCase()}</text>
              </svg>
            </div>
            <div class="payment-card-info">
              <span class="payment-card-number">**** **** **** ${last4 || ''}</span>
              <span class="payment-card-expiry">${exp}</span>
            </div>
            <span class="payment-card-default">Default</span>
            <button class="payment-card-edit" id="billingPortalBtn">Edit</button>
          </div>
          <button class="add-payment-btn" id="billingPortalAddBtn">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <line x1="12" y1="5" x2="12" y2="19"></line>
              <line x1="5" y1="12" x2="19" y2="12"></line>
            </svg>
            Manage Payment Methods
          </button>
        `;
        document.getElementById('billingPortalBtn')?.addEventListener('click', openBillingPortal);
        document.getElementById('billingPortalAddBtn')?.addEventListener('click', openBillingPortal);
      };
      const renderInvoices = (invoices) => {
        const body = document.getElementById('billingHistoryRows');
        if (!body) return;
        if (!invoices || !invoices.length) {
          body.innerHTML = '<div class="billing-row"><span class="muted">No invoices yet.</span></div>';
          return;
        }
        body.innerHTML = invoices.map((inv) => {
          const created = formatDate(inv.created || inv.period_end);
          const desc = inv.description || 'Subscription';
          const amt = formatMoney(inv.amount_paid ?? inv.amount_due, inv.currency);
          const status = (inv.status || '').toLowerCase();
          const statusCls = status === 'paid' ? 'paid' : '';
          const url = inv.hosted_invoice_url || inv.invoice_pdf;
          const downloadBtn = url ? `
            <a class="download-btn" href="${url}" target="_blank" rel="noopener" aria-label="Download invoice">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                <polyline points="7 10 12 15 17 10"></polyline>
                <line x1="12" y1="15" x2="12" y2="3"></line>
              </svg>
            </a>` : '';
          return `
            <div class="billing-row">
              <span>${created}</span>
              <span>${desc}</span>
              <span>${amt}</span>
              <span class="status-badge ${statusCls}">${status ? status.charAt(0).toUpperCase() + status.slice(1) : ''}</span>
              ${downloadBtn}
            </div>
          `;
        }).join('');
      };
      const loadBillingSummary = async () => {
        if (billingLoaded) return;
        billingLoaded = true;
        try {
          const res = await fetch('/api/billing/summary', { credentials: 'include' });
          if (!res.ok) throw new Error();
          const data = await res.json();
          renderBillingPlan(data);
          renderPaymentMethod(data?.payment_method);
          renderInvoices(data?.invoices || []);
        } catch (_) {
          const pm = document.getElementById('billingPaymentMethods');
          const inv = document.getElementById('billingHistoryRows');
          if (pm) pm.innerHTML = '<div class="muted">Could not load payment method.</div>';
          if (inv) inv.innerHTML = '<div class="billing-row"><span class="muted">Could not load invoices.</span></div>';
        }
      };

      // Trigger billing load when tab is opened
      document.querySelector('[data-tab=\"billing\"]')?.addEventListener('click', () => {
        loadBillingSummary();
      });
      // Also load eagerly for logged-in users
      loadBillingSummary();
      document.getElementById('billingManageBtn')?.addEventListener('click', openBillingPortal);

      // Help dropdown toggle (match shared layout)
      (function(){
        const btn = document.getElementById('help-btn');
        const menu = document.getElementById('help-menu');
        if (!btn || !menu) return;
        const toggle = (open) => {
          menu.style.display = open ? 'block' : 'none';
          btn.setAttribute('aria-expanded', open ? 'true' : 'false');
        };
        btn.addEventListener('click', function(){
          const isOpen = menu.style.display === 'block';
          toggle(!isOpen);
        });
        document.addEventListener('click', function(e){
          if (!btn.contains(e.target) && !menu.contains(e.target)) toggle(false);
        });
      })();

      // Avatar dropdown toggle (match shared layout)
      (function(){
        const btn = document.getElementById('avatar-btn');
        const menu = document.getElementById('avatar-menu');
        if (!btn || !menu) return;
        const toggle = (open) => {
          menu.style.display = open ? 'block' : 'none';
          btn.setAttribute('aria-expanded', open ? 'true' : 'false');
        };
        btn.addEventListener('click', function(){
          const isOpen = menu.style.display === 'block';
          toggle(!isOpen);
        });
        document.addEventListener('click', function(e){
          if (!btn.contains(e.target) && !menu.contains(e.target)) toggle(false);
        });
      })();

      // Avatar Upload Logic
      (function initAvatarUpload() {
        const modal = document.getElementById('avatarModal');
        const editBtn = document.querySelector('.avatar-edit-btn');
        const closeBtn = document.getElementById('avatarModalClose');
        const cancelBtn = document.getElementById('avatarCancelBtn');
        const saveBtn = document.getElementById('avatarSaveBtn');
        const fileInput = document.getElementById('avatarFileInput');
        const dropZone = document.getElementById('avatarDropZone');
        const placeholder = document.getElementById('uploadPlaceholder');
        const cropContainer = document.getElementById('cropContainer');
        const cropImage = document.getElementById('cropImage');
        const cropZoom = document.getElementById('cropZoom');
        
        let currentFile = null;
        let imgPosition = { x: 0, y: 0 };
        let isDragging = false;
        let dragStart = { x: 0, y: 0 };
        let baseScale = 1; // Scale to fit image in wrapper

        // Open modal
        editBtn?.addEventListener('click', () => {
          modal.style.display = 'flex';
          resetCropper();
        });

        // Close modal
        function closeModal() {
          modal.style.display = 'none';
          resetCropper();
        }
        closeBtn?.addEventListener('click', closeModal);
        cancelBtn?.addEventListener('click', closeModal);
        modal?.addEventListener('click', (e) => {
          if (e.target === modal) closeModal();
        });

        // File selection
        dropZone?.addEventListener('click', (e) => {
          if (!cropContainer.style.display || cropContainer.style.display === 'none') {
            fileInput.click();
          }
        });

        fileInput?.addEventListener('change', (e) => {
          if (e.target.files?.[0]) handleFile(e.target.files[0]);
        });

        // Drag and drop
        ['dragenter', 'dragover'].forEach(evt => {
          dropZone?.addEventListener(evt, (e) => {
            e.preventDefault();
            dropZone.classList.add('dragover');
          });
        });

        ['dragleave', 'drop'].forEach(evt => {
          dropZone?.addEventListener(evt, (e) => {
            e.preventDefault();
            dropZone.classList.remove('dragover');
          });
        });

        dropZone?.addEventListener('drop', (e) => {
          const file = e.dataTransfer?.files?.[0];
          if (file && file.type.startsWith('image/')) handleFile(file);
        });

        function handleFile(file) {
          if (file.size > 5 * 1024 * 1024) {
            alert('File too large. Maximum size is 5MB.');
            return;
          }
          currentFile = file;
          const reader = new FileReader();
          reader.onload = (e) => {
            cropImage.src = e.target.result;
            cropImage.onload = () => {
              placeholder.style.display = 'none';
              cropContainer.style.display = 'block';
              saveBtn.disabled = false;
              centerImage();
            };
          };
          reader.readAsDataURL(file);
        }

        function centerImage() {
          const wrapper = cropImage.parentElement;
          const wrapperSize = Math.min(wrapper.offsetWidth, wrapper.offsetHeight);
          const imgW = cropImage.naturalWidth;
          const imgH = cropImage.naturalHeight;
          
          const minDimension = Math.min(imgW, imgH);
          const maxDimension = Math.max(imgW, imgH);
          
          // Base scale so the smallest dimension fills the 200px crop circle
          baseScale = 200 / minDimension;
          
          // Also ensure the image fits inside the wrapper at min zoom
          const fitInWrapper = wrapperSize / maxDimension;
          if (baseScale < fitInWrapper) {
            baseScale = fitInWrapper;
          }
          
          // Reset zoom (1x now means baseScale)
          cropZoom.value = 1;
          
          const scale = baseScale * parseFloat(cropZoom.value);
          const scaledW = imgW * scale;
          const scaledH = imgH * scale;
          imgPosition.x = (wrapper.offsetWidth - scaledW) / 2;
          imgPosition.y = (wrapper.offsetHeight - scaledH) / 2;
          updateImageTransform();
        }

        function updateImageTransform() {
          const zoom = parseFloat(cropZoom.value);
          const scale = baseScale * zoom;
          cropImage.style.width = cropImage.naturalWidth * scale + 'px';
          cropImage.style.height = cropImage.naturalHeight * scale + 'px';
          cropImage.style.left = imgPosition.x + 'px';
          cropImage.style.top = imgPosition.y + 'px';
        }

        cropZoom?.addEventListener('input', updateImageTransform);

        // Drag to pan image
        cropImage?.addEventListener('mousedown', (e) => {
          isDragging = true;
          dragStart = { x: e.clientX - imgPosition.x, y: e.clientY - imgPosition.y };
          e.preventDefault();
        });

        document.addEventListener('mousemove', (e) => {
          if (!isDragging) return;
          imgPosition.x = e.clientX - dragStart.x;
          imgPosition.y = e.clientY - dragStart.y;
          updateImageTransform();
        });

        document.addEventListener('mouseup', () => isDragging = false);

        function resetCropper() {
          currentFile = null;
          fileInput.value = '';
          cropImage.src = '';
          cropZoom.value = 1;
          placeholder.style.display = 'block';
          cropContainer.style.display = 'none';
          saveBtn.disabled = true;
          imgPosition = { x: 0, y: 0 };
          baseScale = 1;
        }

        // Save - crop and upload
        saveBtn?.addEventListener('click', async () => {
          if (!currentFile) return;
          saveBtn.disabled = true;
          saveBtn.textContent = 'Uploading...';

          try {
            // Create cropped canvas
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            const size = 200; // Output size
            canvas.width = size;
            canvas.height = size;

            const wrapper = cropImage.parentElement;
            const scale = baseScale * parseFloat(cropZoom.value);
            const wrapperCenterX = wrapper.offsetWidth / 2;
            const wrapperCenterY = wrapper.offsetHeight / 2;

            // Calculate source coordinates
            const srcX = (wrapperCenterX - imgPosition.x - size / 2) / scale;
            const srcY = (wrapperCenterY - imgPosition.y - size / 2) / scale;
            const srcSize = size / scale;

            ctx.drawImage(cropImage, srcX, srcY, srcSize, srcSize, 0, 0, size, size);

            // Convert to blob
            const blob = await new Promise(resolve => canvas.toBlob(resolve, 'image/jpeg', 0.9));
            const formData = new FormData();
            formData.append('avatar', blob, 'avatar.jpg');

            const res = await fetch('/api/account/avatar', {
              method: 'POST',
              body: formData,
              credentials: 'include',
              headers: { 'X-CSRF-Token': getCSRF() },
            });
            const data = await res.json();

            if (data.ok && data.avatar_url) {
              // Update UI
              const largeAvatar = document.getElementById('avatarInitials');
              largeAvatar.classList.add('has-image');
              let img = largeAvatar.querySelector('img');
              if (!img) {
                img = document.createElement('img');
                largeAvatar.insertBefore(img, largeAvatar.firstChild);
              }
              img.src = data.avatar_url;

              // Update top avatar too
              const topAvatar = document.getElementById('topAvatar');
              if (topAvatar) {
                topAvatar.innerHTML = `<img src=\"${data.avatar_url}\" style=\"width:100%;height:100%;object-fit:cover;border-radius:50%;\">`;
              }
              closeModal();
            } else {
              alert(data.detail || 'Upload failed');
            }
          } catch (err) {
            alert('Upload failed: ' + err.message);
          } finally {
            saveBtn.disabled = false;
            saveBtn.textContent = 'Save Photo';
          }
        });
      })();

      document.getElementById('savePersonalInfo')?.addEventListener('click', savePersonalInfo);
      document.getElementById('resetPersonalInfo')?.addEventListener('click', () => {
        resetPersonalInfo();
        loadPersonalDraft(true);
      });
      document.querySelectorAll('#profileFirstName, #profileLastName, #profileEmail, #profilePhone, #profileJobTitle').forEach((el) => {
        el.addEventListener('input', () => savePersonalDraft(personalFormValues()));
      });
      document.getElementById('saveAlertPrefs')?.addEventListener('click', saveAlertPreferences);
      ensureFormFieldAttributes();
      upgradeFileInputs();
      bindFileReplaceButtons();
      bindFilePreviews();
      addPanelSaveButtons();
      initSubAccordions();
      initQuickSetupWizard();
      document.querySelectorAll('.company-profile-section input, .company-profile-section textarea, .company-profile-section select').forEach((el) => {
        el.addEventListener('input', updatePanelStatuses);
        el.addEventListener('change', updatePanelStatuses);
      });
      let progressTimeout;
      document.getElementById('companyProfileForm')?.addEventListener('input', () => {
        clearTimeout(progressTimeout);
        progressTimeout = setTimeout(calculateProfileProgress, 500);
      });

      handleHashNavigation();
      bindTeamHandlers();
      loadAccount();
      loadCompanyProfile();
    });
</script>
  <div class="modal-overlay" id="teamInviteModal" style="display:none;">
    <div class="modal">
      <div class="modal-header">
        <h3>Invite Team Member</h3>
        <button class="modal-close" id="teamInviteClose">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label for="teamInviteEmail">Email address</label>
          <input type="email" class="form-input" id="teamInviteEmail" placeholder="teammate@company.com">
          <span class="form-hint">We will email an invite link.</span>
        </div>
        <div class="form-group">
          <label for="teamInviteRole">Role</label>
          <select class="form-select" id="teamInviteRole">
            <option value="member">Member</option>
            <option value="viewer">Viewer</option>
            <option value="manager">Manager</option>
          </select>
          <span class="form-hint">Managers can invite and edit permissions.</span>
        </div>
        <span class="form-hint" id="teamInviteStatus" aria-live="polite"></span>
      </div>
      <div class="modal-footer">
        <button class="btn-ghost" id="teamInviteCancel" type="button">Cancel</button>
        <button class="btn-primary" id="teamInviteSend" type="button">Send Invite</button>
      </div>
    </div>
  </div>
  <div class="modal-overlay" id="quickSetupModal" style="display:none;">
    <div class="modal quick-setup-modal">
      <div class="modal-header">
        <h3>Quick Setup</h3>
        <button class="modal-close" id="quickSetupClose">&times;</button>
      </div>
      <div class="quick-setup-content">
        <div class="quick-setup-progress">
          <span id="quickStepLabel">Step 1 of 5</span>
          <span class="progress-hint">Autosaves to your profile</span>
        </div>
        <div class="quick-setup-steps">
          <div class="quick-step active" data-step="0">
            <h4>Business Basics</h4>
            <div class="form-row">
              <div class="form-group">
                <label>Legal Business Name</label>
                <input type="text" class="form-input" data-field="legal_name">
              </div>
              <div class="form-group">
                <label>Business Type</label>
                <select class="form-select" data-field="business_type">
                  <option value="">Select</option>
                  <option>LLC</option>
                  <option>Corporation</option>
                  <option>Sole Proprietor</option>
                  <option>Partnership</option>
                  <option>Nonprofit</option>
                  <option>Other</option>
                </select>
              </div>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label>Year Founded</label>
                <input type="number" class="form-input" data-field="year_founded" min="1800" max="2100">
              </div>
              <div class="form-group">
                <label>NAICS Codes (optional)</label>
                <input type="text" class="form-input" data-field="naics_codes" placeholder="541330, 541512">
              </div>
            </div>
          </div>
          <div class="quick-step" data-step="1">
            <h4>Location</h4>
            <div class="form-row">
              <div class="form-group">
                <label>Headquarters Address</label>
                <input type="text" class="form-input" data-field="hq_address">
              </div>
              <div class="form-group">
                <label>City</label>
                <input type="text" class="form-input" data-field="city">
              </div>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label>State</label>
                <select class="form-select" data-field="state">
                  <option value="">Select state</option>
                  <option value="AL">Alabama</option>
                  <option value="AK">Alaska</option>
                  <option value="AZ">Arizona</option>
                  <option value="AR">Arkansas</option>
                  <option value="CA">California</option>
                  <option value="CO">Colorado</option>
                  <option value="CT">Connecticut</option>
                  <option value="DE">Delaware</option>
                  <option value="DC">District of Columbia</option>
                  <option value="FL">Florida</option>
                  <option value="GA">Georgia</option>
                  <option value="HI">Hawaii</option>
                  <option value="ID">Idaho</option>
                  <option value="IL">Illinois</option>
                  <option value="IN">Indiana</option>
                  <option value="IA">Iowa</option>
                  <option value="KS">Kansas</option>
                  <option value="KY">Kentucky</option>
                  <option value="LA">Louisiana</option>
                  <option value="ME">Maine</option>
                  <option value="MD">Maryland</option>
                  <option value="MA">Massachusetts</option>
                  <option value="MI">Michigan</option>
                  <option value="MN">Minnesota</option>
                  <option value="MS">Mississippi</option>
                  <option value="MO">Missouri</option>
                  <option value="MT">Montana</option>
                  <option value="NE">Nebraska</option>
                  <option value="NV">Nevada</option>
                  <option value="NH">New Hampshire</option>
                  <option value="NJ">New Jersey</option>
                  <option value="NM">New Mexico</option>
                  <option value="NY">New York</option>
                  <option value="NC">North Carolina</option>
                  <option value="ND">North Dakota</option>
                  <option value="OH">Ohio</option>
                  <option value="OK">Oklahoma</option>
                  <option value="OR">Oregon</option>
                  <option value="PA">Pennsylvania</option>
                  <option value="RI">Rhode Island</option>
                  <option value="SC">South Carolina</option>
                  <option value="SD">South Dakota</option>
                  <option value="TN">Tennessee</option>
                  <option value="TX">Texas</option>
                  <option value="UT">Utah</option>
                  <option value="VT">Vermont</option>
                  <option value="VA">Virginia</option>
                  <option value="WA">Washington</option>
                  <option value="WV">West Virginia</option>
                  <option value="WI">Wisconsin</option>
                  <option value="WY">Wyoming</option>
                </select>
              </div>
              <div class="form-group">
                <label>Zip Code</label>
                <input type="text" class="form-input" data-field="zip">
              </div>
            </div>
          </div>
          <div class="quick-step" data-step="2">
            <h4>Primary Contact</h4>
            <div class="form-row">
              <div class="form-group">
                <label>Full Name</label>
                <input type="text" class="form-input" data-field="primary_name">
              </div>
              <div class="form-group">
                <label>Job Title</label>
                <input type="text" class="form-input" data-field="primary_title">
              </div>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label>Email</label>
                <input type="email" class="form-input" data-field="primary_email">
              </div>
              <div class="form-group">
                <label>Phone</label>
                <input type="tel" class="form-input" data-field="primary_phone">
              </div>
            </div>
          </div>
          <div class="quick-step" data-step="3">
            <h4>Experience & Capability</h4>
            <div class="form-row">
              <div class="form-group">
                <label>Years of Experience</label>
                <input type="number" class="form-input" data-field="years_experience" min="0">
              </div>
              <div class="form-group">
                <label>Warranty Service Capabilities</label>
                <input type="text" class="form-input" data-field="warranty" placeholder="Response times, onsite coverage">
              </div>
            </div>
            <div class="form-group">
              <label>Description of Company Experience</label>
              <textarea class="form-textarea" data-field="experience" rows="3"></textarea>
            </div>
          </div>
          <div class="quick-step" data-step="4">
            <h4>Insurance & Signer</h4>
            <div class="form-row">
              <div class="form-group">
                <label>General Liability Coverage</label>
                <select class="form-select" data-field="gl_coverage">
                  <option value="">Select</option>
                  <option value="yes">Yes</option>
                  <option value="no">No</option>
                </select>
              </div>
              <div class="form-group">
                <label>Workers Compensation Coverage</label>
                <select class="form-select" data-field="wc_coverage">
                  <option value="">Select</option>
                  <option value="yes">Yes</option>
                  <option value="no">No</option>
                </select>
              </div>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label>Authorized Signer Name</label>
                <input type="text" class="form-input" data-field="signer_name">
              </div>
              <div class="form-group">
                <label>Title</label>
                <input type="text" class="form-input" data-field="signer_title">
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn-secondary" id="quickBackBtn" type="button">Back</button>
        <button class="btn-primary" id="quickNextBtn" type="button">Next</button>
      </div>
    </div>
  </div>
  <!-- Avatar Upload Modal -->
  <div class="modal-overlay" id="avatarModal" style="display:none;">
    <div class="modal avatar-modal">
<div class="modal-header">
<h3>Update Profile Photo</h3>
<button class="modal-close" id="avatarModalClose">×</button>
</div>
<div class="modal-body">
<div class="avatar-upload-area" id="avatarDropZone">
<input accept="image/jpeg,image/png,image/webp,image/gif" hidden="" id="avatarFileInput" type="file"/>
<div class="upload-placeholder" id="uploadPlaceholder">
<svg fill="none" height="48" stroke="currentColor" stroke-width="1.5" viewbox="0 0 24 24" width="48">
<path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
<polyline points="17 8 12 3 7 8"></polyline>
<line x1="12" x2="12" y1="3" y2="15"></line>
</svg>
<p>Drop image here or click to upload</p>
<span class="upload-hint">JPG, PNG, WebP or GIF (max 5MB)</span>
</div>
<div class="crop-container" id="cropContainer" style="display:none;">
<div class="crop-wrapper">
<img alt="Crop preview" id="cropImage" src=""/>
<div class="crop-overlay">
<div class="crop-circle" id="cropCircle"></div>
</div>
</div>
<div class="crop-controls">
<label for="cropZoom">Zoom</label>
<input id="cropZoom" max="3" min="1" step="0.1" type="range" value="1"/>
</div>
</div>
</div>
</div>
<div class="modal-footer">
<button class="btn btn-secondary" id="avatarCancelBtn">Cancel</button>
<button class="btn btn-primary" disabled="" id="avatarSaveBtn">Save Photo</button>
</div>
</div>
</div>
<div class="notif-overlay" id="notifOverlay"></div>
<div class="notif-sidebar" id="notifSidebar">
<div class="notif-header">
<div class="notif-header-top">
<h2 class="notif-title">Notifications</h2>
<div class="notif-header-actions">
<button class="notif-action-btn" id="markAllRead" title="Mark all as read">
<svg fill="none" height="18" stroke="currentColor" stroke-width="2" viewbox="0 0 24 24" width="18">
<polyline points="20 6 9 17 4 12"></polyline>
</svg>
</button>
<button class="notif-close-btn" id="notifCloseBtn">
<svg fill="none" height="20" stroke="currentColor" stroke-width="2" viewbox="0 0 24 24" width="20">
<line x1="18" x2="6" y1="6" y2="18"></line>
<line x1="6" x2="18" y1="6" y2="18"></line>
</svg>
</button>
</div>
</div>
<div class="notif-tabs">
<button class="notif-tab active" data-filter="all">All</button>
<button class="notif-tab" data-filter="unread">Unread <span class="notif-tab-count">0</span></button>
<button class="notif-tab" data-filter="deadlines">Deadlines</button>
<button class="notif-tab" data-filter="team">Team</button>
</div>
</div>
<div class="notif-list" id="notifList">
<div class="notif-date-group">
<div class="notif-date-label">Today</div>
<div class="notif-item" data-type="info">
<div class="notif-item-icon info">
<svg fill="none" height="18" stroke="currentColor" stroke-width="2" viewbox="0 0 24 24" width="18">
<circle cx="12" cy="12" r="10"></circle>
<line x1="12" x2="12" y1="16" y2="12"></line>
<line x1="12" x2="12" y1="8" y2="8"></line>
</svg>
</div>
<div class="notif-item-content">
<div class="notif-item-title">Loading notifications...</div>
<div class="notif-item-desc">Please wait</div>
<div class="notif-item-meta">
<span class="notif-time"></span>
</div>
</div>
</div>
</div>
</div>
<div class="notif-footer">
<a class="notif-settings-link" href="/account#tab-notifications">Notification settings</a>
</div>
</div>
<script src="/static/js/notifications.js"></script>
</body>
</html>
